<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="Prometheuså†…éƒ¨å®ç°(ä¸‰)" />
    <meta name="hexo-theme-A4" content="v1.9.7" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Coronarium | Drill down</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


<meta name="generator" content="Hexo 6.3.0"></head>
    
    

    
    



    

    
    

    
    <style>
        :root {
            --waline-theme-color: #9e5345; 
            --waline-color: #9e5345; 
            --waline-border-color: #9e5345; 
            --waline-white: #9e5345; 
            --waline-bgcolor-light: #efeae2;  
        }
        body {
            color: #9e5345;
            background: #e8e0c9;
        }
        .post-md code {
            background: #e4e4e4;
            color: #2e5041; 
        }
        .post-md pre, .post-md .highlight {
            background: #e4e4e4;
            color: #2e5041; 
        }
        pre .string, pre .value, pre .inheritance, pre .header, pre .ruby .symbol, pre .xml .cdata {
            color: #9e5345;
        }
        pre .number, pre .preprocessor, pre .built_in, pre .literal, pre .params, pre .constant {
            color: #9e5345;
        }
        .year-font-color {
            color: #9e5345 !important;
        }
        .wl-card span.wl-nick {
            color: #9e5345; 
        }
        .wl-card .wl-badge {
            border: 1px solid #9e5345;
            color: #9e5345; 
        }
        .wl-btn {
            border: 1px solid #9e5345; 
            color:  #9e5345;  
        }
        .wl-btn.primary {
            color: #efeae2; 
        }
        .wl-header label {
            color: #9e5345;
        }
        a {
            color: #2e5041;
        }

        .post-md a {
            color: #2e5041;
        }

        .nav li a {
            color: #2e5041;
        }

        .archive-main a:link {
            color: #2e5041;
        }
        .archive-main a:visited {
            color: #9c9caf; 
        }

        .archive li span {
            color: #9e5345;
        }

        .post-main-title {
            color: #9e5345;
        }

        .post-md h1,
        .post-md h2,
        .post-md h3,
        .post-md h4,
        .post-md h5,
        .post-md h6 {
            color: #9e5345;
        }

        [data-waline] p {
            color: #9e5345;
        }
        [data-waline] a {
            color: #9e5345;
        } 
        .wl-sort li.active {
            color: #9e5345;
        }

        .wl-card .wl-meta>span {
            background: #efeae2;
        }

        .paper {
            background: #e8e0c9;
        }

        .index-main {
            background: #efeae2;
        }

        .paper-main {
            background: #efeae2;
        }

        .wl-panel {
            background: #efeae2;
        }

        .archive li:nth-child(odd) {
            background: #efeae2;
            ;
        }

        .archive li:nth-child(even) {
            background: #efeae2;
        }

        .post-md table tr:nth-child(odd) td {
            background: #efeae2;
        }

        .post-md table tr:nth-child(even) td {
            background: #efeae2;
        }

    
        .progress-wrap::after {
            color: #9e5345; /* ç®­å¤´çš„é¢œè‰² */
        }
        .progress-wrap svg.progress-circle path {
	        stroke: #9e5345; /* è¾¹æ¡†çš„é¢œè‰² */
        }
        .progress-wrap::before {
	        background-image: linear-gradient(298deg, #2e5041, #2e5041); /* é¼ æ ‡æ»‘è¿‡çš„ç®­å¤´é¢œè‰² */
         }

        .return-to-last-progress-wrap::after {
            color: #9e5345; /* ç®­å¤´çš„é¢œè‰² */
        }
        .return-to-last-progress-wrap svg.progress-circle path {
	        stroke: #9e5345; /* è¾¹æ¡†çš„é¢œè‰² */
        }
        .return-to-last-progress-wrap::before {
	        background-image: linear-gradient(298deg, #2e5041, #2e5041); /* é¼ æ ‡æ»‘è¿‡çš„ç®­å¤´é¢œè‰² */
         }

         .left-toc-container::-webkit-scrollbar-thumb {
            background-color: #9e5345; /* è®¾ç½®æ»šåŠ¨æ¡æ‹–åŠ¨å—çš„é¢œè‰² */
        }

        .bs-docs-sidebar .nav>.active>a,
        .bs-docs-sidebar .nav>li>a:hover,
        .bs-docs-sidebar .nav>li>a:focus {
            color: #2e5041;
            border-left-color: #2e5041;
        }
        .bs-docs-sidebar .nav>li>a {
            color:  #9e5345;
        }
    </style>

    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e8e0c9  ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 0; 
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/img/favicon.webp" 
        />
        <div class="header-content">
            <a class="logo" href="/">Coronarium</a> 
            <span class="description">ä¸“æ³¨ã€æ¢ç´¢ã€ç§¯ç´¯</span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« </a></li>
            
        
            
                <li><a href="/about/">å…³äº</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    Prometheuså†…éƒ¨å®ç°(ä¸‰)
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2023-09-10</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š2.8k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š15åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                
            
        
        <div class=".article-gallery"><blockquote>
<p>éçº¿æ€§ &#x3D;&gt; çº¿æ€§ï¼Œæ··ä¹± &#x3D;&gt; ç§©åº</p>
</blockquote>
<p>ä¸Šä¸€ç¯‡åšæ–‡ä¸»è¦å†™äº†Prometheus serverçš„å¯åŠ¨è¿‡ç¨‹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ·±å…¥å„ä¸ªç»„ä»¶ï¼Œäº†è§£å…¶å…·ä½“å®ç°ï¼Œè¿™ç¯‡æ–‡ä»¶ä¸»è¦ä»‹ç»Initial configuration loadingéƒ¨åˆ†ã€‚</p>
<p>Prometheus serverçš„mainå‡½æ•°æœ‰ä¸¤ä¸ªå¾ˆç²¾å½©çš„å®ç°ï¼Œä¸€ä¸ªæ˜¯reloaderçš„æ³¨å†Œï¼Œä¸€ä¸ªæ˜¯ç»„ä»¶å¯åŠ¨ã€‚ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œæ‰€æœ‰çš„ç»„ä»¶éƒ½æ˜¯åŒæ—¶å¯åŠ¨çš„å—ï¼Ÿè¿˜æ˜¯æœ‰ä»€ä¹ˆé¡ºåºï¼Ÿ</p>
<p>æˆ‘ä»¬åˆ—ä¸€ä¸ªç»„ä»¶æ¸…å•ï¼š</p>
<pre><code class="txt">- Termination handler.
- Scrape discovery manager.
- Notify discovery manager.
- Scrape manager.
- Reload handler.
- Rule manager.
- TSDB.
- Web handler.
- Notifier.
</code></pre>
<p>å†æ¥çœ‹ä¸€ä¸‹ç»„ä»¶å¯åŠ¨ä½¿ç”¨çš„åº•å±‚æŠ€æœ¯:</p>
<blockquote>
<p>run.Group is a universal mechanism to manage goroutine lifecycles.</p>
<p>Create a zero-value run.Group, and then add actors to it. Actors are defined as a pair of functions: an <strong>execute</strong> function, which should run synchronously; and an <strong>interrupt</strong> function, which, when invoked, should cause the execute function to return. Finally, invoke Run, which concurrently runs all of the actors, waits until the first actor exits, invokes the interrupt functions, and finally returns control to the caller only once all actors have returned. This general-purpose API allows callers to model pretty much any runnable task, and achieve well-defined lifecycle semantics for the group.</p>
<p>run.Group was written to manage component lifecycles in func main for <a target="_blank" rel="noopener" href="https://github.com/oklog/oklog">OK Log</a>. But itâ€™s useful in any circumstance where you need to orchestrate multiple goroutines as a unit whole. <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=LHe1Cb_Ud_M&t=15m45s">Click here</a> to see a video of a talk where run.Group is described.</p>
<p>source: <a target="_blank" rel="noopener" href="https://pkg.go.dev/github.com/oklog/run">https://pkg.go.dev/github.com/oklog/run</a></p>
</blockquote>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œoklog&#x2F;runåº“çš„run.Groupå®ç°äº†ä¸€ç§goroutineç”Ÿå‘½çš„ç®¡ç†æœºåˆ¶ï¼Œä½¿ç”¨äº†actoræ¨¡å‹ï¼Œæ³¨å†Œä¸€å¯¹å‡½æ•°executeå’Œinterruptã€‚å›å¿†ä¸€ä¸‹ä¸Šç¯‡åšå®¢ï¼Œå®ç°æ­£æ˜¯å¦‚æ­¤ã€‚</p>
<p>Termination handlerç»„ä»¶çš„executeå‡½æ•°ä½¿ç”¨selectç­‰å¾…termã€webHandlerã€cancelçš„é€šçŸ¥ï¼Œç”¨äºä¿è¯ç³»ç»Ÿæ­£å¸¸é€€å‡ºï¼Œè¿›å…¥å³é˜»å¡ã€‚</p>
<p>Scrape discovery managerç»„ä»¶ç›´æ¥è°ƒç”¨discoveryManagerScrape.Runã€‚</p>
<p>Notify discovery managerç»„ä»¶ç›´æ¥è°ƒç”¨discoveryManagerNotify.Runã€‚</p>
<p>Scrape managerç»„ä»¶ç­‰å¾…reloadReady.Cé€šçŸ¥ï¼Œç„¶åè¿è¡ŒscrapeManager.Runã€‚</p>
<p>Reload handlerç»„ä»¶ç­‰å¾…reloadReady.Cé€šçŸ¥ï¼Œç„¶åç­‰å¾…hupã€webHandlerã€cancelçš„é€šçŸ¥ï¼Œæ ¹æ®é€šçŸ¥é‡æ–°åŠ è½½ã€‚</p>
<p>Initial configuration loadingç»„ä»¶è¿›å…¥åç­‰å¾…dbOpenã€cancelé€šçŸ¥ï¼ŒdbOpené€šçŸ¥åï¼ŒåŠ è½½é…ç½®ã€‚</p>
<p>Rule managerç»„ä»¶ç­‰å¾…reloadReady.Cé€šçŸ¥ï¼Œç„¶åè¿è¡ŒruleManager.Runã€‚</p>
<p>TSDBç»„ä»¶è¿è¡ŒopenDBWithMetricsï¼Œç„¶åclose dbOpen channelã€‚</p>
<p>Web handlerç»„ä»¶ç›´æ¥è°ƒç”¨webHandler.Runã€‚</p>
<p>Notifierç»„ä»¶ç­‰å¾…reloadReady.Cé€šçŸ¥ï¼Œç„¶åè°ƒç”¨notifierManager.Runã€‚</p>
<p>å¯ä»¥çœ‹å‡ºæ•´ä¸ªæ§åˆ¶æµç¨‹æœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„channelï¼šdbOpenå’ŒreloadReady.Cã€‚æˆ‘ä»¬å†çœ‹çœ‹è¿™ä¸¤ä¸ªchannelï¼Œ</p>
<pre><code class="go">// Start all components while we wait for TSDB to open but only load
// initial config and mark ourselves as ready after it completed.
dbOpen := make(chan struct&#123;&#125;)

// sync.Once is used to make sure we can close the channel at different execution stages(SIGTERM or when the config is loaded).
type closeOnce struct &#123;
  C     chan struct&#123;&#125;
  once  sync.Once
  Close func()
&#125;
// Wait until the server is ready to handle reloading.
reloadReady := &amp;closeOnce&#123;
  C: make(chan struct&#123;&#125;),
&#125;
reloadReady.Close = func() &#123;
  reloadReady.once.Do(func() &#123;
    close(reloadReady.C)
  &#125;)
&#125;
</code></pre>
<p>æ ¹æ®ä¸Šé¢çš„æ€»ç»“ï¼ŒTermination handlerã€Scrape discovery managerã€Notify discovery managerã€TSDBã€Web handlerç»„ä»¶ç›´æ¥è¿è¡Œï¼ŒTSDBåˆå§‹åŒ–ç»“æŸåï¼Œå…³é—­dbOpen channelï¼Œæ¥ç€Initial configuration loadingç»“æŸé˜»å¡ï¼Œå¼€å§‹è¿è¡Œï¼Œåœ¨æŸå¤„å…³é—­äº†reloadReady.C channelåï¼Œç­‰å¾…è¯¥channelé€šçŸ¥çš„ç»„ä»¶å¼€å§‹è¿è¡Œã€‚</p>
<p>Initial configuration loadingç»„ä»¶çš„executeå‡½æ•°å¦‚ä¸‹ï¼Œå¯è§æœ€é‡è¦çš„å°±æ˜¯reloadConfigå‡½æ•°çš„å®ç°</p>
<pre><code class="go">select &#123;
  case &lt;-dbOpen:
  // In case a shutdown is initiated before the dbOpen is released
  case &lt;-cancel:
  reloadReady.Close()
  return nil
&#125;

if err := reloadConfig(cfg.configFile, logger, noStepSubqueryInterval, reloaders...); err != nil &#123;
  return errors.Wrapf(err, &quot;error loading config from %q&quot;, cfg.configFile)
&#125;

reloadReady.Close()
</code></pre>
<p>reloadConfigå‡½æ•°å®ç°å¦‚ä¸‹</p>
<pre><code class="go">func reloadConfig(filename string, logger log.Logger, noStepSuqueryInterval *safePromQLNoStepSubqueryInterval, rls ...reloader) (err error) &#123;
  start := time.Now()
  timings := []interface&#123;&#125;&#123;&#125;
  level.Info(logger).Log(&quot;msg&quot;, &quot;Loading configuration file&quot;, &quot;filename&quot;, filename)

  defer func() &#123;
    if err == nil &#123;
      configSuccess.Set(1)
      configSuccessTime.SetToCurrentTime()
    &#125; else &#123;
      configSuccess.Set(0)
    &#125;
  &#125;()

  conf, err := config.LoadFile(filename)
  if err != nil &#123;
    return errors.Wrapf(err, &quot;couldn&#39;t load configuration (--config.file=%q)&quot;, filename)
  &#125;

  failed := false
  for _, rl := range rls &#123;
    rstart := time.Now()
    if err := rl.reloader(conf); err != nil &#123;
      level.Error(logger).Log(&quot;msg&quot;, &quot;Failed to apply configuration&quot;, &quot;err&quot;, err)
      failed = true
    &#125;
    timings = append(timings, rl.name, time.Since(rstart))
  &#125;
  if failed &#123;
    return errors.Errorf(&quot;one or more errors occurred while applying the new configuration (--config.file=%q)&quot;, filename)
  &#125;

  noStepSuqueryInterval.Set(conf.GlobalConfig.EvaluationInterval)
  l := []interface&#123;&#125;&#123;&quot;msg&quot;, &quot;Completed loading of configuration file&quot;, &quot;filename&quot;, filename, &quot;totalDuration&quot;, time.Since(start)&#125;
  level.Info(logger).Log(append(l, timings...)...)
  return nil
&#125;
</code></pre>
<p>è¯¥å‡½æ•°é‡Œé¢æœ‰ä¸¤ä¸ªé‡è¦åŠŸèƒ½ï¼Œä¸€ä¸ªæ˜¯è§£æé…ç½®æ–‡ä»¶ï¼Œå¦ä¸€ä¸ªæ˜¯è°ƒç”¨reloaderã€‚reloaderçš„è°ƒç”¨å…ˆä¸æ·±ç©¶ï¼Œæˆ‘ä»¬ç•™åˆ°ä¸‹ä¸€ç¯‡è®²scrapeçš„æ—¶å€™å†ç ”ç©¶ï¼Œè¿™é‡Œå…ˆç ”ç©¶ä¸€ä¸‹é…ç½®æ–‡ä»¶çš„è§£æï¼Œè¿™ä¸ªä¹Ÿæ˜¯ç›¸å½“ç²¾å½©çš„ã€‚é…ç½®æ–‡ä»¶çš„structå®šä¹‰å¦‚ä¸‹ï¼Œ</p>
<pre><code class="go">type Config struct &#123;
    GlobalConfig   GlobalConfig    `yaml:&quot;global&quot;`
    AlertingConfig AlertingConfig  `yaml:&quot;alerting,omitempty&quot;`
    RuleFiles      []string        `yaml:&quot;rule_files,omitempty&quot;`
    ScrapeConfigs  []*ScrapeConfig `yaml:&quot;scrape_configs,omitempty&quot;`

    RemoteWriteConfigs []*RemoteWriteConfig `yaml:&quot;remote_write,omitempty&quot;`
    RemoteReadConfigs  []*RemoteReadConfig  `yaml:&quot;remote_read,omitempty&quot;`
&#125;
</code></pre>
<p>å› ä¸ºéœ€è¦æ”¯æŒå„ç§åŠ¨æ€å‘ç°ç»„ä»¶ï¼ŒServiceDiscoveryConfigsåœ¨è¿™é‡Œtag keyä¸ºâ€œ-â€ï¼Œè¡¨ç¤ºä¸è§£æï¼Œconfig.goè‡ªå®šä¹‰å®ç°äº†UnmarshalYAMLï¼Œç”¨äºè§£æé…ç½®</p>
<pre><code class="go">type ScrapeConfig struct &#123;
    // The job name to which the job label is set by default.
    JobName string `yaml:&quot;job_name&quot;`
    // Indicator whether the scraped metrics should remain unmodified.
    HonorLabels bool `yaml:&quot;honor_labels,omitempty&quot;`
    // Indicator whether the scraped timestamps should be respected.
    HonorTimestamps bool `yaml:&quot;honor_timestamps&quot;`
    // A set of query parameters with which the target is scraped.
    Params url.Values `yaml:&quot;params,omitempty&quot;`
    // How frequently to scrape the targets of this scrape config.
    ScrapeInterval model.Duration `yaml:&quot;scrape_interval,omitempty&quot;`
    // The timeout for scraping targets of this config.
    ScrapeTimeout model.Duration `yaml:&quot;scrape_timeout,omitempty&quot;`
    // The HTTP resource path on which to fetch metrics from targets.
    MetricsPath string `yaml:&quot;metrics_path,omitempty&quot;`
    // The URL scheme with which to fetch metrics from targets.
    Scheme string `yaml:&quot;scheme,omitempty&quot;`
    // More than this many samples post metric-relabeling will cause the scrape to fail.
    SampleLimit uint `yaml:&quot;sample_limit,omitempty&quot;`
    // More than this many targets after the target relabeling will cause the
    // scrapes to fail.
    TargetLimit uint `yaml:&quot;target_limit,omitempty&quot;`

    // We cannot do proper Go type embedding below as the parser will then parse
    // values arbitrarily into the overflow maps of further-down types.

    ServiceDiscoveryConfigs discovery.Configs       `yaml:&quot;-&quot;`
    HTTPClientConfig        config.HTTPClientConfig `yaml:&quot;,inline&quot;`

    // List of target relabel configurations.
    RelabelConfigs []*relabel.Config `yaml:&quot;relabel_configs,omitempty&quot;`
    // List of metric relabel configurations.
    MetricRelabelConfigs []*relabel.Config `yaml:&quot;metric_relabel_configs,omitempty&quot;`
&#125;
</code></pre>
<p><code>conf, err := config.LoadFile(filename)</code>è¿™ä¸ªè°ƒç”¨è¿”å›ä¸€ä¸ªConfigæŒ‡é’ˆï¼Œ</p>
<pre><code class="go">func Load(s string) (*Config, error) &#123;
  cfg := &amp;Config&#123;&#125;
  // If the entire config body is empty the UnmarshalYAML method is
  // never called. We thus have to set the DefaultConfig at the entry
  // point as well.
  *cfg = DefaultConfig

  err := yaml.UnmarshalStrict([]byte(s), cfg)
  if err != nil &#123;
    return nil, err
  &#125;
  return cfg, nil
&#125;
</code></pre>
<p><code>err := yaml.UnmarshalStrict([]byte(s), cfg)</code>è°ƒç”¨Configçš„yaml Unmarshalæ–¹æ³•ï¼Œè§£æé…ç½®ï¼Œä½†æ˜¯Prometheusè‡ªå®šä¹‰äº†æ•´ä¸ªé…ç½®æ–‡ä»¶çš„è§£æï¼ŒConfigçš„UnmarshalYAMLå®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="go">func (c *Config) UnmarshalYAML(unmarshal func(interface&#123;&#125;) error) error &#123;
  *c = DefaultConfig
  // We want to set c to the defaults and then overwrite it with the input.
  // To make unmarshal fill the plain data struct rather than calling UnmarshalYAML
  // again, we have to hide it using a type indirection.
  type plain Config
  if err := unmarshal((*plain)(c)); err != nil &#123;
    return err
  &#125;

  // If a global block was open but empty the default global config is overwritten.
  // We have to restore it here.
  if c.GlobalConfig.isZero() &#123;
    c.GlobalConfig = DefaultGlobalConfig
  &#125;

  for _, rf := range c.RuleFiles &#123;
    if !patRulePath.MatchString(rf) &#123;
      return errors.Errorf(&quot;invalid rule file path %q&quot;, rf)
    &#125;
  &#125;
  // Do global overrides and validate unique names.
  jobNames := map[string]struct&#123;&#125;&#123;&#125;
  for _, scfg := range c.ScrapeConfigs &#123;
    if scfg == nil &#123;
      return errors.New(&quot;empty or null scrape config section&quot;)
    &#125;
    // First set the correct scrape interval, then check that the timeout
    // (inferred or explicit) is not greater than that.
    if scfg.ScrapeInterval == 0 &#123;
      scfg.ScrapeInterval = c.GlobalConfig.ScrapeInterval
    &#125;
    if scfg.ScrapeTimeout &gt; scfg.ScrapeInterval &#123;
      return errors.Errorf(&quot;scrape timeout greater than scrape interval for scrape config with job name %q&quot;, scfg.JobName)
    &#125;
    if scfg.ScrapeTimeout == 0 &#123;
      if c.GlobalConfig.ScrapeTimeout &gt; scfg.ScrapeInterval &#123;
        scfg.ScrapeTimeout = scfg.ScrapeInterval
      &#125; else &#123;
        scfg.ScrapeTimeout = c.GlobalConfig.ScrapeTimeout
      &#125;
    &#125;

    if _, ok := jobNames[scfg.JobName]; ok &#123;
      return errors.Errorf(&quot;found multiple scrape configs with job name %q&quot;, scfg.JobName)
    &#125;
    jobNames[scfg.JobName] = struct&#123;&#125;&#123;&#125;
  &#125;
  rwNames := map[string]struct&#123;&#125;&#123;&#125;
  for _, rwcfg := range c.RemoteWriteConfigs &#123;
    if rwcfg == nil &#123;
      return errors.New(&quot;empty or null remote write config section&quot;)
    &#125;
    // Skip empty names, we fill their name with their config hash in remote write code.
    if _, ok := rwNames[rwcfg.Name]; ok &amp;&amp; rwcfg.Name != &quot;&quot; &#123;
      return errors.Errorf(&quot;found multiple remote write configs with job name %q&quot;, rwcfg.Name)
    &#125;
    rwNames[rwcfg.Name] = struct&#123;&#125;&#123;&#125;
  &#125;
  rrNames := map[string]struct&#123;&#125;&#123;&#125;
  for _, rrcfg := range c.RemoteReadConfigs &#123;
    if rrcfg == nil &#123;
      return errors.New(&quot;empty or null remote read config section&quot;)
    &#125;
    // Skip empty names, we fill their name with their config hash in remote read code.
    if _, ok := rrNames[rrcfg.Name]; ok &amp;&amp; rrcfg.Name != &quot;&quot; &#123;
      return errors.Errorf(&quot;found multiple remote read configs with job name %q&quot;, rrcfg.Name)
    &#125;
    rrNames[rrcfg.Name] = struct&#123;&#125;&#123;&#125;
  &#125;
  return nil
&#125;
</code></pre>
<p>è¿™ä¸ªé…ç½®çš„è§£æå’ŒéªŒè¯å®åœ¨æ˜¯å¤ªå¤æ‚äº†ï¼Œæˆ‘ä»¬ä¸ç®¡å…¶ä»–struct fieldçš„unmarshalï¼Œå…³æ³¨scrape configsçš„è§£æï¼Œ</p>
<pre><code class="go">func (c *ScrapeConfig) UnmarshalYAML(unmarshal func(interface&#123;&#125;) error) error &#123;
  *c = DefaultScrapeConfig
  if err := discovery.UnmarshalYAMLWithInlineConfigs(c, unmarshal); err != nil &#123;
    return err
  &#125;
  if len(c.JobName) == 0 &#123;
    return errors.New(&quot;job_name is empty&quot;)
  &#125;

  // The UnmarshalYAML method of HTTPClientConfig is not being called because it&#39;s not a pointer.
  // We cannot make it a pointer as the parser panics for inlined pointer structs.
  // Thus we just do its validation here.
  if err := c.HTTPClientConfig.Validate(); err != nil &#123;
    return err
  &#125;

  // Check for users putting URLs in target groups.
  if len(c.RelabelConfigs) == 0 &#123;
    if err := checkStaticTargets(c.ServiceDiscoveryConfigs); err != nil &#123;
      return err
    &#125;
  &#125;

  for _, rlcfg := range c.RelabelConfigs &#123;
    if rlcfg == nil &#123;
      return errors.New(&quot;empty or null target relabeling rule in scrape config&quot;)
    &#125;
  &#125;
  for _, rlcfg := range c.MetricRelabelConfigs &#123;
    if rlcfg == nil &#123;
      return errors.New(&quot;empty or null metric relabeling rule in scrape config&quot;)
    &#125;
  &#125;

  return nil
&#125;
</code></pre>
<p><code>err := discovery.UnmarshalYAMLWithInlineConfigs(c, unmarshal)</code>é‡Œé¢æ˜¯è§£æåŠ¨æ€å‘ç°çš„å…·ä½“å®ç°ï¼Œ let us drill downï¼š</p>
<pre><code class="go">func UnmarshalYAMLWithInlineConfigs(out interface&#123;&#125;, unmarshal func(interface&#123;&#125;) error) error &#123;
  outVal := reflect.ValueOf(out)
  if outVal.Kind() != reflect.Ptr &#123;
    return fmt.Errorf(&quot;discovery: can only unmarshal into a struct pointer: %T&quot;, out)
  &#125;
  outVal = outVal.Elem()
  if outVal.Kind() != reflect.Struct &#123;
    return fmt.Errorf(&quot;discovery: can only unmarshal into a struct pointer: %T&quot;, out)
  &#125;
  outTyp := outVal.Type()

  cfgTyp := getConfigType(outTyp)
  cfgPtr := reflect.New(cfgTyp)
  cfgVal := cfgPtr.Elem()

  // Copy shared fields (defaults) to dynamic value.
  var configs *Configs
  for i, n := 0, outVal.NumField(); i &lt; n; i++ &#123;
    if outTyp.Field(i).Type == configsType &#123;
      configs = outVal.Field(i).Addr().Interface().(*Configs)
      continue
    &#125;
    if cfgTyp.Field(i).PkgPath != &quot;&quot; &#123;
      continue // Field is unexported: ignore.
    &#125;
    cfgVal.Field(i).Set(outVal.Field(i))
  &#125;
  if configs == nil &#123;
    return fmt.Errorf(&quot;discovery: Configs field not found in type: %T&quot;, out)
  &#125;

  // Unmarshal into dynamic value.
  if err := unmarshal(cfgPtr.Interface()); err != nil &#123;
    return replaceYAMLTypeError(err, cfgTyp, outTyp)
  &#125;

  // Copy shared fields from dynamic value.
  for i, n := 0, outVal.NumField(); i &lt; n; i++ &#123;
    if cfgTyp.Field(i).PkgPath != &quot;&quot; &#123;
      continue // Field is unexported: ignore.
    &#125;
    outVal.Field(i).Set(cfgVal.Field(i))
  &#125;

  var err error
  *configs, err = readConfigs(cfgVal, outVal.NumField())
  return err
&#125;
</code></pre>
<p>Oh, my god! è¿™ä¸ªå¤ªåˆºæ¿€äº†ï¼Œç”¨reflectå»å®ç°åº•å±‚çš„æ•°æ®è§£æï¼Œè¿™ä¸ªä»¥åè¦çœ‹çœ‹åº•å±‚çš„å®ç°ï¼Œå…ˆä¸ç®¡äº†ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸Šé¢å‡½æ•°çš„å€’æ•°ç¬¬äºŒå¥æœ‰è¿™æ ·ä¸€ä¸ªè°ƒç”¨<code>*configs, err = readConfigs(cfgVal, outVal.NumField())</code>ï¼Œç»§ç»­drill down</p>
<pre><code class="go">func readConfigs(structVal reflect.Value, startField int) (Configs, error) &#123;
  var (
    configs Configs
    targets []*targetgroup.Group
  )
  for i, n := startField, structVal.NumField(); i &lt; n; i++ &#123;
    field := structVal.Field(i)
    if field.Kind() != reflect.Slice &#123;
      panic(&quot;discovery: internal error: field is not a slice&quot;)
    &#125;
    for k := 0; k &lt; field.Len(); k++ &#123;
      val := field.Index(k)
      if val.IsZero() || (val.Kind() == reflect.Ptr &amp;&amp; val.Elem().IsZero()) &#123;
        key := configFieldNames[field.Type().Elem()]
        key = strings.TrimPrefix(key, configFieldPrefix)
        return nil, fmt.Errorf(&quot;empty or null section in %s&quot;, key)
      &#125;
      switch c := val.Interface().(type) &#123;
        case *targetgroup.Group:
        // Add index to the static config target groups for unique identification
        // within scrape pool.
        c.Source = strconv.Itoa(len(targets))
        // Coalesce multiple static configs into a single static config.
        targets = append(targets, c)
        case Config:
        configs = append(configs, c)
        default:
        panic(&quot;discovery: internal error: slice element is not a Config&quot;)
      &#125;
    &#125;
  &#125;
  if len(targets) &gt; 0 &#123;
    configs = append(configs, StaticConfig(targets))
  &#125;
  return configs, nil
&#125;
</code></pre>
<p>å‰å®³äº†å‰å®³äº†ï¼Œæˆ‘ä»¬ç»ˆäºè§£æå®Œäº†scrape configï¼Œç»ˆäºçŸ¥é“å¯ä»¥å»æŠ“å–å“ªäº›ç›®æ ‡metricsäº†ã€‚å—¯ï¼Œåˆæœ‰æ–°ç›®æ ‡ï¼Œäº†è§£yamlåº•å±‚è§£æçš„åŸç†ï¼ï¼ï¼</p>
<p>ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥ç€ç ”ç©¶Prometheus serverçš„scrapeå®ç°ã€‚</p>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2021-03-20</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« Bray Wang</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/Golang-Prometheus-Observability/'>
                            Golang, Prometheus, Observability
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/Golang/'>
                            Golang
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                
                    <span>ä¸Šä¸€ç¯‡ï¼š<a href='/2021/03/22/Prometheus%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0-%E5%9B%9B/'>Prometheuså†…éƒ¨å®ç°(å››)</a></span>
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2021/03/15/Prometheus%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0-%E4%BA%8C/">Prometheuså†…éƒ¨å®ç°(äºŒ)</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© Jerry Wang 

            
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>â˜€ï¸ç™½é©¹è¿‡éš™,æ—¶å…‰èè‹’ğŸŒ›</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>