<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  viewport-fit=cover" name="viewport" />
    <meta name="description" content="k8s集群搭建" />
    <meta name="hexo-theme-A4" content="v1.7.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Coronarium | Drill down</title>

    
        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
    
    
<link rel="stylesheet" href="/css/ui.css">
 
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.0.0-rc2"></head>
    
    <body>
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    
<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Coronarium</a> 
            <span class="description">专注、探索、积累</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">首页</a></li>
            
        
            
                <li><a href="/list/">文章</a></li>
            
        
            
                <li><a href="/about/">关于</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            k8s集群搭建
        </div>
      
    

    <div class="post-md">
        
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1%E3%80%81%E8%8A%82%E7%82%B9"><span class="post-toc-text">1、节点</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2%E3%80%81docker%E5%AE%89%E8%A3%85"><span class="post-toc-text">2、docker安装</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3%E3%80%81kubernetes%E5%AE%89%E8%A3%85"><span class="post-toc-text">3、kubernetes安装</span></a></li></ol>
        
        <h2 id="1、节点"><a href="#1、节点" class="headerlink" title="1、节点"></a>1、节点</h2><table>
<thead>
<tr>
<th>节点</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.124.100</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.124.101</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.124.102</td>
</tr>
<tr>
<td>node3</td>
<td>192.168.124.103</td>
</tr>
</tbody></table>
<h2 id="2、docker安装"><a href="#2、docker安装" class="headerlink" title="2、docker安装"></a>2、docker安装</h2><p>安装使用官方源，安装命令如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载仓库</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d</span><br><span class="line">wget https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum makecache fast</span><br><span class="line"><span class="comment"># 安装docker</span></span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io</span><br><span class="line"><span class="comment"># 启动docker</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure>

<h2 id="3、kubernetes安装"><a href="#3、kubernetes安装" class="headerlink" title="3、kubernetes安装"></a>3、kubernetes安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="comment"># 添加仓库</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新yum cache</span></span><br><span class="line">yum makecache fast</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubeadm初始化会报错, 需要执行下列命令</span></span><br><span class="line"><span class="comment"># 1、关闭firewalld</span></span><br><span class="line">systemctl diable firewalld &amp;&amp; systemctl stop firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、关闭selinux</span></span><br><span class="line">setenforce 0 &amp;&amp; sed -i <span class="string">&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3、关闭swap</span></span><br><span class="line">swapoff -a &amp;&amp; sed -i <span class="string">&#x27;/ swap / s/^/#/&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4、设置网络</span></span><br><span class="line"><span class="built_in">touch</span> /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">modprobe br_netfilter &amp;&amp; sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># master节点执行</span></span><br><span class="line">yum install kubeadm kubectl kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有node节点执行</span></span><br><span class="line">yum install kubeadm kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动实际运行容器的服务kubelet</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在执行kubelet会报错，不用管</span></span><br><span class="line"><span class="comment"># kubeadm init或join之后，systemd会自动拉起kubelet</span></span><br><span class="line"><span class="comment"># kubeadm是集群管理工具</span></span><br><span class="line"><span class="comment"># kubelet负责运行pods</span></span><br><span class="line"><span class="comment"># kubectl是客户端，负责和kube-apiserver通信</span></span><br><span class="line"><span class="comment"># 用类比解释的话，kubectl是curl，kube-apiserver是服务器</span></span><br><span class="line"><span class="comment"># kube-controller-manager是控制器</span></span><br><span class="line"><span class="comment"># kube-scheduler是调度器</span></span><br><span class="line"><span class="comment"># kube-proxy负责网络通信</span></span><br><span class="line"><span class="comment"># pause是pod空闲运行的镜像</span></span><br><span class="line"><span class="comment"># etcd用于分布式存储集群信息</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于kubeadm使用镜像拉起k8s，但是被墙了，所以在可以翻墙的主机上下载镜像，然后使用下列命令导出镜像</span></span><br><span class="line"><span class="comment"># docker save -o package.tar.gz image1:latest</span></span><br><span class="line"><span class="comment"># 使用下面命令导入镜像</span></span><br><span class="line"><span class="comment"># docker load -i package.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取需要下载的镜像列表</span></span><br><span class="line">kubeadm config images list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下，master表示在主节点安装，node表示在从节点安装</span></span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.16.1 <span class="comment"># master </span></span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.16.1 <span class="comment"># master </span></span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.16.1 <span class="comment"># master </span></span><br><span class="line">k8s.gcr.io/kube-proxy:v1.16.1 <span class="comment"># master node </span></span><br><span class="line">k8s.gcr.io/pause:3.1 <span class="comment"># node </span></span><br><span class="line">k8s.gcr.io/etcd:3.3.15-0 <span class="comment"># master </span></span><br><span class="line">k8s.gcr.io/coredns:1.6.2 <span class="comment"># master node </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 很不幸，被墙了</span></span><br><span class="line"><span class="comment"># 用可以翻墙的主机用docker pull拉取镜像，上传本地即可</span></span><br><span class="line"><span class="comment"># 镜像的打包使用save命令</span></span><br><span class="line"><span class="comment"># 镜像的导入使用load命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载好镜像，导入完毕</span></span><br><span class="line"><span class="comment"># 在master节点执行</span></span><br><span class="line">kubeadm init --kubernetes-version=v1.16.1 --apiserver-advertise-address=192.168.124.100 --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行成功后，会提示进行如下操作</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点加入集群操作</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.124.100:6443 --token ba04v7.y9ki5jgbss8gs0jx \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:8404de0f262daf02de05aad96415c79c2ff39b91ce3ee28cd8248426166123a9 </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s的网络模型是扁平化的，即pod之间需要能够直接访问，在谷歌的实现中，已经支持扁平化网络模型</span></span><br><span class="line"><span class="comment"># 但是我们创建的集群，不满足这种网络模型，所以需要借助插件或者进行主机配置之后才能满足</span></span><br><span class="line"><span class="comment"># 刚开始学习建议使用flannel，减少障碍，后期有需要进行调研学习</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装flannel</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在master执行</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出，暂时配置了两个节点</span></span><br><span class="line">NAME     STATUS   ROLES    AGE   VERSION</span><br><span class="line">master   Ready    master   50m   v1.16.1</span><br><span class="line">node1    Ready    &lt;none&gt;   27m   v1.16.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 没有安装flannel之前，查看nodes，会提示STATUS为NotReady。</span></span><br><span class="line"><span class="comment"># 至此，k8s的基本安装就结束了。</span></span><br><span class="line"><span class="comment"># 是不是很简单</span></span><br><span class="line"><span class="comment"># 后续会继续分享k8s的学习</span></span><br></pre></td></tr></table></figure>


    </div>

    <div class="post-meta">
        <i>
        
            <span>2019-10-15</span>
            
                <span>该篇文章被 Bray Wang</span>
            
            
             
                <span>归为分类:
                    
                    
                        <a href='/categories/k8s/'>
                            k8s
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    
        

     
</div>



                    
                    
                    <div class="footer">
    
        <span> 
            © Bray Wang 

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span>☀️白驹过隙,时光荏苒🌛</span>
            
                <span class="footer-last-span-right"><i>本站由<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>驱动｜使用<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>主题</i></span>
            
    
</div>


    
<link rel="stylesheet" href="/css/a11y-dark.min.css">

    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>



<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>
                </div>
            
    </body>
</html>