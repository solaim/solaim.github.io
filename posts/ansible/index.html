<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ansible | Jerry Wang</title>
<meta name=keywords content="Python,Ansible"><meta name=description content="1、 What is ansible?

Ansible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.
Ansible是一个颠覆性的运维工具，支持云配置、配置管理、应用部署、服务编配等运维工作。

Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.
Ansible一开始就是为多层架构设计的，因此Ansible通过描述系统内部关系，进行整体建模。


It uses no agents and no additional custom security infrastructure, so it&rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English."><meta name=author content="Jerry Wang"><link rel=canonical href=https://solaim.github.io/posts/ansible/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://solaim.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://solaim.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://solaim.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://solaim.github.io/apple-touch-icon.png><link rel=mask-icon href=https://solaim.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://solaim.github.io/posts/ansible/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://solaim.github.io/posts/ansible/"><meta property="og:site_name" content="Jerry Wang"><meta property="og:title" content="Ansible"><meta property="og:description" content="1、 What is ansible? Ansible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.
Ansible是一个颠覆性的运维工具，支持云配置、配置管理、应用部署、服务编配等运维工作。
Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.
Ansible一开始就是为多层架构设计的，因此Ansible通过描述系统内部关系，进行整体建模。
It uses no agents and no additional custom security infrastructure, so it’s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-04-10T21:21:23+08:00"><meta property="article:modified_time" content="2019-04-10T21:21:23+08:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Ansible"><meta property="og:image" content="https://solaim.github.io/img/favicon.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://solaim.github.io/img/favicon.webp"><meta name=twitter:title content="Ansible"><meta name=twitter:description content="1、 What is ansible?

Ansible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.
Ansible是一个颠覆性的运维工具，支持云配置、配置管理、应用部署、服务编配等运维工作。

Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.
Ansible一开始就是为多层架构设计的，因此Ansible通过描述系统内部关系，进行整体建模。


It uses no agents and no additional custom security infrastructure, so it&rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://solaim.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Ansible","item":"https://solaim.github.io/posts/ansible/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ansible","name":"Ansible","description":"1、 What is ansible? Ansible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.\nAnsible是一个颠覆性的运维工具，支持云配置、配置管理、应用部署、服务编配等运维工作。\nDesigned for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.\nAnsible一开始就是为多层架构设计的，因此Ansible通过描述系统内部关系，进行整体建模。\nIt uses no agents and no additional custom security infrastructure, so it\u0026rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English.\n","keywords":["Python","Ansible"],"articleBody":"1、 What is ansible? Ansible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.\nAnsible是一个颠覆性的运维工具，支持云配置、配置管理、应用部署、服务编配等运维工作。\nDesigned for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.\nAnsible一开始就是为多层架构设计的，因此Ansible通过描述系统内部关系，进行整体建模。\nIt uses no agents and no additional custom security infrastructure, so it’s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English.\nAnsible no agents no additional custom security infrastucture, it use ssh describe automation jobs by yaml 2、How to Ansible? 尽管各种平台的管理工具都可以安装Ansible，但是Ansible是Python开发的，所以Ansible的安装建议尽量使用pip:\npip install ansible 如果想使用平台管理工具安装，具体查询官网。\n检查安装结果：\nansible --version 输出结果：\nansible 2.7.6 config file = None configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Nov 6 2016, 00:28:07) [GCC 4.8.5 20150623 (Red Hat 4.8.5-11)] 使用pip安装的Ansible没有自动生成配置文件，需要手动生成。使用平台工具安装会自动生成Ansible配置文件。\nAnsible的核心是Playbooks。Playbooks是一个yaml格式的文本文件，用于描述事务状态。Playbooks的使用变量Variables描述，Variables可以在Playbooks、File、Inventories、Command line、Discovered variables、Ansible Tower等中定义。\nInventories类似中药药方，中药药方基本是这么写的：\n当归莲子汤 当归 两钱 莲子 四钱 ... Inventories描述服务器的Host列表、范围、动态范围以及自定义。\nPlaybooks contain plays\nPlays contain tasks\nTasks call modules\nTasks run sequentially\nHandlers are triggered by Tasks, and are run once, at the end of Plays\n高级Playbooks支持条件触发以及role等特征。定义好Playbooks之后，具体怎么运行Ansible呢？\n运行Ansible有三种主流的方式：\nAd-Hoc：ansible -m Playbooks：ansible-playbook Automation Framework：Ansible Tower(AWX) 3、Could you give me a demo? 创建ansible目录 mkdir -p /etc/ansible 创建ansible.cfg touch /etc/ansible/ansible.cfg 编辑ansible.cfg # config file for ansible -- https://ansible.com/ # =============================================== # nearly all parameters can be overridden in ansible-playbook # or with command line flags. ansible will read ANSIBLE_CONFIG, # ansible.cfg in the current working directory, .ansible.cfg in # the home directory or /etc/ansible/ansible.cfg, whichever it # finds first [defaults] # some basic default values... inventory = /etc/ansible/hosts library = /usr/share/ansible/ #module_utils = /usr/share/my_module_utils/ #remote_tmp = ~/.ansible/tmp #local_tmp = ~/.ansible/tmp #plugin_filters_cfg = /etc/ansible/plugin_filters.yml forks = 5 #poll_interval = 15 sudo_user = root #ask_sudo_pass = True #ask_pass = True #transport = smart remote_port = 22 #module_lang = C #module_set_locale = False [inventory] [privilege_escalation] [paramiko_connection] [ssh_connection] [persistent_connection] [accelerate] [selinux] [colors] [diff] 详细配置文件，请参考Github网页。\n编辑Inventory /etc/ansible/hosts 192.168.0.142 使用Ad-hoc方式运行命令： ansible all -m ping ansible all -a \"/bin/echo hello\" 4、Yelp, but how to do with complex deployment? Playbooks is really good!!!\nPlaybooks is really good!!!\nPlaybooks is really good!!!\n病比较复杂，就需要一系列工具来辅助治疗。最常用的工具有ansible和ansible-playbook。但是还有很多其他工具，比如：\nansible-config: 用于查看、编辑、和管理ansible配置。\nansible-console：用于执行ansible ad-hoc 的repl console。\nansible-doc：插件文档工具，用于查看ansible modules的描述信息。\nansible-galaxy：ansible执行角色相关的操作。\nansible-inventory：用于查看inventory。\nansible-pull：从VCS仓库拉取playbooks并在本地执行。\nansible-vault：用于ansible数据文件加解密。\n工具用的熟就好，但是主要工具不仅要用的熟，还得用的巧。ansible和ansible-playbook就是这样的工具。\nansible：用于定义和执行单一任务\nansible-playbook：运行ansible playbook，在目标主机群上执行定义的任务。\n来看两个简单的ansible使用示例：\nansible all -a \"/sbin/reboot\" -f 10 ansible all -m shell -a 'echo $TERM' 第一个例子开启10个进程，让所有主机重启。当然，如果all中定义的主机数目小于10，比如5，那么有5个进程就是空闲的。如果all中有12个主机，那么有两个任务会等待。参数 -f 10 用来指定进程数目。\n第二个例子打印TERM参数，但是使用-m指定了模块，一般默认的模块是’command’。\n这两个都是简单的例子，ansible的模块支持更加复杂的任务。比如文件操作：\nansible all -m copy -a \"src=/etc/hosts dest=/tmp/hosts\" # 类似于scp ansible all -m file -a \"dest=/srv/foo/a.txt mode=600\" ansible all -m file -a \"dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan\" # 类似于chmod等命令 ansible webservers -m file -a \"dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory\" # 类似于mkdir -p ansible webservers -m file -a \"dest=/path/to/c state=absent\" # 类似于rm 比如管理包：\nansible webservers -m yum -a \"name=acme state=present\" # 确保安装，但是不升级 ansible webservers -m yum -a \"name=acme-1.5 state=present\" # 确保安装指定版本 ansible webservers -m yum -a \"name=acme state=latest\" # 确保安装最新版本 ansible webservers -m yum -a \"name=acme state=absent\" # 确保未安装 比如用户和组的管理：\nansible all -m user -a \"name=foo password=\" # 创建用户 ansible all -m user -a \"name=foo state=absent\" # 删除用户 比如源码部署：\nansible webservers -m git -a \"repo=https://foo.example.org/repo.git dest=/srv/myapp version=HEAD\" 比如服务管理：\nansible webservers -m service -a \"name=httpd state=started\" # 开启 ansible webservers -m service -a \"name=httpd state=restarted\" # 重启 ansible webservers -m service -a \"name=httpd state=stopped\" # 关闭 比如限时后台任务：\nansible all -B 3600 -P 0 -a \"/usr/bin/long_running_operation --do-stuff\" # /usr/bin/long_running_operation一个后台任务，-B表示超时时间，-P表示轮询polling ansible web1.example.com -m async_status -a \"jid=488359678239.2844\" # 使用async_status检查异步任务状态 ansible all -B 1800 -P 60 -a \"/usr/bin/long_running_operation --do-stuff\" # 在启动任务的同时开启轮询模式，任务执行30分钟，每60秒检查一次状态 比如获取系统信息：\nansible all -m setup 嗯，ansible ad-hoc是很好用，但是我想把任务记录下来，下次直接执行，怎么办呢？\n这个就要用到ansible-playbook了，不过我们先来看看inventory。\nansible运行在复杂环境架构中，为了任务管理、运行方便，可以从inventory list中选取需要操作的主机组进行操作。inventory默认的存储文件是/etc/ansible/hosts，不过可以使用-i path进行指定。\ninventory支持多文件同时配置，支持动态拉取，支持不同格式的文件。\nmail.example.com [webservers] foo.example.com bar.example.com [dbservers] one.example.com two.example.com three.example.com 这是一个ini格式的inventory，[webservers]表示group，可以方便的选取执行相关任务的主机，并且表明主机的用途。yaml格式的像这样：\nall: hosts: mail.example.com: children: webservers: hosts: foo.example.com: bar.example.com: dbservers: hosts: one.example.com: two.example.com: three.example.com: 如果ssh使用的不是标准端口，需要在inventory中标明：\nbadwolf.example.com:5309 inventory支持使用变量定义主机：\njumper ansible_port=5555 ansible_host=192.0.2.50 ... hosts: jumper: ansible_port: 5555 ansible_host: 192.0.2.50 inventory支持模式匹配，如果主机类型模式类似，可以像这样：\n[webservers] www[01:50].example.com [databases] db-[a:f].example.com inventory支持定义连接类型和用户：\n[targets] localhost ansible_connection=local other1.example.com ansible_connection=ssh ansible_user=mpdehaan other2.example.com ansible_connection=ssh ansible_user=mdehaan 可以在inventory中直接定义变量，但是更常用的方法是在host_vars目录的单独文件中进行定义，然后在inventory中进行引用：\n[atlanta] host1 http_port=80 maxRequestsPerChild=808 host2 http_port=303 maxRequestsPerChild=909 [atlanta] host1 host2 [atlanta:vars] ntp_server=ntp.atlanta.example.com proxy=proxy.atlanta.example.com [atlanta] host1 host2 [atlanta:vars] ntp_server=ntp.atlanta.example.com proxy=proxy.atlanta.example.com host和group均支持变量。但是切记，这只是一种表示方法，实际执行的时候会用literal替代。\ninventory有两个默认组：all和ungrouped。all包含所有主机，ungrouped包含没有分组的主机。当然inventory支持更复杂的定义方式，但是，这只是入门级使用手册，不一一赘述。快点进入重点吧，怎么用Playbooks呢？\n如果你有一间作坊，那么modules就是你的工具，Playbooks就是你的操作手册，inventory就是原料。\n记住，Playbooks是ansible的语言、的语言、的语言…\n5、Oh，No！sophisticated Playbooks… - hosts: webservers remote_user: root tasks: - name: ensure apache is at the latest version yum: name: httpd state: latest - name: write the apache config file template: src: /srv/httpd.j2 dest: /etc/httpd.conf - hosts: databases remote_user: root tasks: - name: ensure postgresql is at the latest version yum: name: postgresql state: latest - name: ensure that postgresql is started service: name: postgresql state: started 这个Playbooks示例中，有两个play，第一个现在webservers group执行apache安装和配置，第二个在databases group执行postgresql安装和启动。Playbooks顺序执行。\nPlaybooks contain plays\nPlays contain tasks\nTasks call modules\nTasks run sequentially\nHandlers are triggered by Tasks, and are run once, at the end of Plays\n一个play必须指定目标主机和操作用户，注意是远程操作用户。目标主机通过-hosts指定，操作用户使用remote_user指定，支持细分task指定不同操作用户，支持用户切换。hosts是目标主机的列表，若有多组目标主机，使用冒号分割。一个play可以有多个task，每个task必须指定任务名称，任务调用模块，模块的调用格式为module: options。options分为key-value形式和非key-value形式的。\ntasks: - name: make sure apache is running service: name: httpd state: started # key-value tasks: - name: enable selinux command: /sbin/setenforce 1 # non key-value 根据上面的两个例子，可以看出options的格式根据modules发生变化。任务可以出发handler，比如两个任务task均涉及到nginx配置文件的修改，在task 的notify中均定义了handler，那么在play执行的最后，将只执行一次handler，避免nginx重复重启。\nname: template configuration file template: src: template.j2 dest: /etc/foo.conf notify: - restart memcached - restart apache handlers: - name: restart memcached service: name: memcached state: restarted - name: restart apache service: name: apache state: restarted 执行Playbooks的命令行：\nansible-playbook playbook.yml 一个简单的nginx安装示例：\n- hosts: all remote_user: root tasks: - name: yum install nginx yum: name: nginx state: latest ","wordCount":"852","inLanguage":"en","image":"https://solaim.github.io/img/favicon.webp","datePublished":"2019-04-10T21:21:23+08:00","dateModified":"2019-04-10T21:21:23+08:00","author":{"@type":"Person","name":"Jerry Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://solaim.github.io/posts/ansible/"},"publisher":{"@type":"Organization","name":"Jerry Wang","logo":{"@type":"ImageObject","url":"https://solaim.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://solaim.github.io/ accesskey=h title="首页 (Alt + H)"><img src=https://solaim.github.io/apple-touch-icon.png alt aria-label=logo height=35>首页</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://solaim.github.io/categories/ title=🕸分类><span>🕸分类</span></a></li><li><a href=https://solaim.github.io/tags/ title=🐚标签><span>🐚标签</span></a></li><li><a href=https://solaim.github.io/about/ title=🌏关于><span>🌏关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://solaim.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://solaim.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Ansible</h1><div class=post-meta><span title='2019-04-10 21:21:23 +0800 +0800'>2019-04-10</span>&nbsp;·&nbsp;Jerry Wang</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#1-what-is-ansible>1、 What is ansible?</a></li><li><a href=#2how-to-ansible>2、How to Ansible?</a></li><li><a href=#3could-you-give-me-a-demo>3、Could you give me a demo?</a></li><li><a href=#4yelp-but-how-to-do-with-complex-deployment>4、Yelp, but how to do with complex deployment?</a></li><li><a href=#5ohnosophisticated-playbooks>5、Oh，No！sophisticated Playbooks&mldr;</a></li></ul></nav></div></details></div><div class=post-content><h2 id=1-what-is-ansible>1、 What is ansible?<a hidden class=anchor aria-hidden=true href=#1-what-is-ansible>#</a></h2><blockquote><p>Ansible is a radically simple IT automation engine that automates <em>cloud provisioning</em>, <em>configuration management</em>, <em>application deployment</em>, <em>intra-service orchestration</em>, and many other IT needs.</p></blockquote><p>Ansible是一个颠覆性的运维工具，支持云配置、配置管理、应用部署、服务编配等运维工作。</p><blockquote><p>Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.</p></blockquote><p>Ansible一开始就是为多层架构设计的，因此Ansible通过描述系统内部关系，进行整体建模。</p><p><img alt=AnsibleArchitecture loading=lazy src=/img/AnsibleArchitecture.png></p><blockquote><p>It uses no agents and no additional custom security infrastructure, so it&rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English.</p></blockquote><ul><li>Ansible no agents</li><li>no additional custom security infrastucture, it use ssh</li><li>describe automation jobs by yaml</li></ul><h2 id=2how-to-ansible>2、How to Ansible?<a hidden class=anchor aria-hidden=true href=#2how-to-ansible>#</a></h2><p>尽管各种平台的管理工具都可以安装Ansible，但是Ansible是Python开发的，所以Ansible的安装建议尽量使用pip:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>pip install ansible
</span></span></code></pre></div><p>如果想使用平台管理工具安装，具体查询<a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html>官网</a>。</p><p>检查安装结果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible --version
</span></span></code></pre></div><p>输出结果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible 2.7.6
</span></span><span class=line><span class=cl>  config <span class=nv>file</span> <span class=o>=</span> None
</span></span><span class=line><span class=cl>  configured module search <span class=nv>path</span> <span class=o>=</span> <span class=o>[</span>u<span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  ansible python module <span class=nv>location</span> <span class=o>=</span> /usr/lib/python2.7/site-packages/ansible
</span></span><span class=line><span class=cl>  executable <span class=nv>location</span> <span class=o>=</span> /usr/bin/ansible
</span></span><span class=line><span class=cl>  python <span class=nv>version</span> <span class=o>=</span> 2.7.5 <span class=o>(</span>default, Nov  <span class=m>6</span> 2016, 00:28:07<span class=o>)</span> <span class=o>[</span>GCC 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-11<span class=o>)]</span>
</span></span></code></pre></div><p>使用pip安装的Ansible没有自动生成配置文件，需要手动生成。使用平台工具安装会自动生成Ansible配置文件。</p><p>Ansible的核心是<strong>Playbooks</strong>。<strong>Playbooks</strong>是一个yaml格式的文本文件，用于描述事务状态。<strong>Playbooks</strong>的使用变量<em>Variables</em>描述，<em>Variables</em>可以在Playbooks、File、Inventories、Command line、Discovered variables、Ansible Tower等中定义。</p><p><strong>Inventories</strong>类似中药药方，中药药方基本是这么写的：</p><pre tabindex=0><code>当归莲子汤

当归 两钱
莲子 四钱
...
</code></pre><p><strong>Inventories</strong>描述服务器的Host列表、范围、动态范围以及自定义。</p><blockquote><p><strong>Playbooks</strong> contain <strong>plays</strong></p><p><strong>Plays</strong> contain <strong>tasks</strong></p><p><strong>Tasks</strong> call <strong>modules</strong></p><p><strong>Tasks</strong> run sequentially</p><p><strong>Handlers</strong> are triggered by <strong>Tasks</strong>, and are run once, at the end of <strong>Plays</strong></p></blockquote><p>高级Playbooks支持条件触发以及role等特征。定义好Playbooks之后，具体怎么运行Ansible呢？</p><p>运行Ansible有三种主流的方式：</p><ul><li>Ad-Hoc：ansible -m</li><li>Playbooks：ansible-playbook</li><li>Automation Framework：Ansible Tower(AWX)</li></ul><h2 id=3could-you-give-me-a-demo>3、Could you give me a demo?<a hidden class=anchor aria-hidden=true href=#3could-you-give-me-a-demo>#</a></h2><ul><li><input disabled type=checkbox> 创建ansible目录</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir -p /etc/ansible
</span></span></code></pre></div><ul><li><input disabled type=checkbox> 创建ansible.cfg</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>touch /etc/ansible/ansible.cfg
</span></span></code></pre></div><ul><li><input disabled type=checkbox> 编辑ansible.cfg</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># config file for ansible -- https://ansible.com/</span>
</span></span><span class=line><span class=cl><span class=c1># ===============================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nearly all parameters can be overridden in ansible-playbook</span>
</span></span><span class=line><span class=cl><span class=c1># or with command line flags. ansible will read ANSIBLE_CONFIG,</span>
</span></span><span class=line><span class=cl><span class=c1># ansible.cfg in the current working directory, .ansible.cfg in</span>
</span></span><span class=line><span class=cl><span class=c1># the home directory or /etc/ansible/ansible.cfg, whichever it</span>
</span></span><span class=line><span class=cl><span class=c1># finds first</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[defaults]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># some basic default values...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>inventory</span>      <span class=o>=</span> <span class=s>/etc/ansible/hosts</span>
</span></span><span class=line><span class=cl><span class=na>library</span>        <span class=o>=</span> <span class=s>/usr/share/ansible/</span>
</span></span><span class=line><span class=cl><span class=c1>#module_utils   = /usr/share/my_module_utils/</span>
</span></span><span class=line><span class=cl><span class=c1>#remote_tmp     = ~/.ansible/tmp</span>
</span></span><span class=line><span class=cl><span class=c1>#local_tmp      = ~/.ansible/tmp</span>
</span></span><span class=line><span class=cl><span class=c1>#plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span>
</span></span><span class=line><span class=cl><span class=na>forks</span>          <span class=o>=</span> <span class=s>5</span>
</span></span><span class=line><span class=cl><span class=c1>#poll_interval  = 15</span>
</span></span><span class=line><span class=cl><span class=na>sudo_user</span>      <span class=o>=</span> <span class=s>root</span>
</span></span><span class=line><span class=cl><span class=c1>#ask_sudo_pass = True</span>
</span></span><span class=line><span class=cl><span class=c1>#ask_pass      = True</span>
</span></span><span class=line><span class=cl><span class=c1>#transport      = smart</span>
</span></span><span class=line><span class=cl><span class=na>remote_port</span>    <span class=o>=</span> <span class=s>22</span>
</span></span><span class=line><span class=cl><span class=c1>#module_lang    = C</span>
</span></span><span class=line><span class=cl><span class=c1>#module_set_locale = False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[inventory]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[privilege_escalation]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[paramiko_connection]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[ssh_connection]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[persistent_connection]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[accelerate]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[selinux]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[colors]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[diff]</span>
</span></span></code></pre></div><p>详细配置文件，请参考Github<a href=https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg>网页</a>。</p><ul><li><input disabled type=checkbox> 编辑Inventory /etc/ansible/hosts</li></ul><pre tabindex=0><code>192.168.0.142
</code></pre><ul><li><input disabled type=checkbox> 使用Ad-hoc方式运行命令：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m ping
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ansible all -a <span class=s2>&#34;/bin/echo hello&#34;</span>
</span></span></code></pre></div><h2 id=4yelp-but-how-to-do-with-complex-deployment>4、Yelp, but how to do with complex deployment?<a hidden class=anchor aria-hidden=true href=#4yelp-but-how-to-do-with-complex-deployment>#</a></h2><p><strong>Playbooks</strong> is really good!!!</p><p><strong>Playbooks</strong> is really good!!!</p><p><strong>Playbooks</strong> is really good!!!</p><p>病比较复杂，就需要一系列工具来辅助治疗。最常用的工具有ansible和ansible-playbook。但是还有很多其他工具，比如：</p><blockquote><p><strong>ansible-config</strong>: 用于查看、编辑、和管理ansible配置。</p></blockquote><blockquote><p><strong>ansible-console</strong>：用于执行ansible ad-hoc 的repl console。</p></blockquote><blockquote><p><strong>ansible-doc</strong>：插件文档工具，用于查看ansible modules的描述信息。</p></blockquote><blockquote><p><strong>ansible-galaxy</strong>：ansible执行角色相关的操作。</p></blockquote><blockquote><p><strong>ansible-inventory</strong>：用于查看inventory。</p></blockquote><blockquote><p><strong>ansible-pull</strong>：从VCS仓库拉取playbooks并在本地执行。</p></blockquote><blockquote><p><strong>ansible-vault</strong>：用于ansible数据文件加解密。</p></blockquote><p>工具用的熟就好，但是主要工具不仅要用的熟，还得用的巧。ansible和ansible-playbook就是这样的工具。</p><blockquote><p><strong>ansible</strong>：用于定义和执行单一任务</p></blockquote><blockquote><p><strong>ansible-playbook</strong>：运行ansible playbook，在目标主机群上执行定义的任务。</p></blockquote><p>来看两个简单的ansible使用示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -a <span class=s2>&#34;/sbin/reboot&#34;</span> -f <span class=m>10</span>
</span></span><span class=line><span class=cl>ansible all -m shell -a <span class=s1>&#39;echo $TERM&#39;</span>
</span></span></code></pre></div><p>第一个例子开启10个进程，让所有主机重启。当然，如果all中定义的主机数目小于10，比如5，那么有5个进程就是空闲的。如果all中有12个主机，那么有两个任务会等待。参数 -f 10 用来指定进程数目。</p><p>第二个例子打印TERM参数，但是使用-m指定了模块，一般默认的模块是&rsquo;command&rsquo;。</p><p>这两个都是简单的例子，ansible的模块支持更加复杂的任务。比如文件操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m copy -a <span class=s2>&#34;src=/etc/hosts dest=/tmp/hosts&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类似于scp</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m file -a <span class=s2>&#34;dest=/srv/foo/a.txt mode=600&#34;</span>
</span></span><span class=line><span class=cl>ansible all -m file -a <span class=s2>&#34;dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 类似于chmod等命令</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m file -a <span class=s2>&#34;dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类似于mkdir -p</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m file -a <span class=s2>&#34;dest=/path/to/c state=absent&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 类似于rm</span>
</span></span></code></pre></div><p>比如管理包：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme state=present&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 确保安装，但是不升级</span>
</span></span><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme-1.5 state=present&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 确保安装指定版本</span>
</span></span><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme state=latest&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 确保安装最新版本</span>
</span></span><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme state=absent&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 确保未安装</span>
</span></span></code></pre></div><p>比如用户和组的管理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m user -a <span class=s2>&#34;name=foo password=&lt;crypted password here&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 创建用户</span>
</span></span><span class=line><span class=cl>ansible all -m user -a <span class=s2>&#34;name=foo state=absent&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 删除用户</span>
</span></span></code></pre></div><p>比如源码部署：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m git -a <span class=s2>&#34;repo=https://foo.example.org/repo.git dest=/srv/myapp version=HEAD&#34;</span>
</span></span></code></pre></div><p>比如服务管理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m service -a <span class=s2>&#34;name=httpd state=started&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 开启</span>
</span></span><span class=line><span class=cl>ansible webservers -m service -a <span class=s2>&#34;name=httpd state=restarted&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 重启</span>
</span></span><span class=line><span class=cl>ansible webservers -m service -a <span class=s2>&#34;name=httpd state=stopped&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 关闭</span>
</span></span></code></pre></div><p>比如限时后台任务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -B <span class=m>3600</span> -P <span class=m>0</span> -a <span class=s2>&#34;/usr/bin/long_running_operation --do-stuff&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># /usr/bin/long_running_operation一个后台任务，-B表示超时时间，-P表示轮询polling</span>
</span></span><span class=line><span class=cl>ansible web1.example.com -m async_status -a <span class=s2>&#34;jid=488359678239.2844&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 使用async_status检查异步任务状态</span>
</span></span><span class=line><span class=cl>ansible all -B <span class=m>1800</span> -P <span class=m>60</span> -a <span class=s2>&#34;/usr/bin/long_running_operation --do-stuff&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 在启动任务的同时开启轮询模式，任务执行30分钟，每60秒检查一次状态</span>
</span></span></code></pre></div><p>比如获取系统信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m setup
</span></span></code></pre></div><p>嗯，ansible ad-hoc是很好用，但是我想把任务记录下来，下次直接执行，怎么办呢？</p><p>这个就要用到ansible-playbook了，不过我们先来看看inventory。</p><p>ansible运行在复杂环境架构中，为了任务管理、运行方便，可以从inventory list中选取需要操作的主机组进行操作。inventory默认的存储文件是<code>/etc/ansible/hosts</code>，不过可以使用<code>-i path</code>进行指定。</p><p>inventory支持多文件同时配置，支持动态拉取，支持不同格式的文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>mail.example.com</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[webservers]</span>
</span></span><span class=line><span class=cl><span class=na>foo.example.com</span>
</span></span><span class=line><span class=cl><span class=na>bar.example.com</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[dbservers]</span>
</span></span><span class=line><span class=cl><span class=na>one.example.com</span>
</span></span><span class=line><span class=cl><span class=na>two.example.com</span>
</span></span><span class=line><span class=cl><span class=na>three.example.com</span>
</span></span></code></pre></div><p>这是一个ini格式的inventory，[webservers]表示group，可以方便的选取执行相关任务的主机，并且表明主机的用途。yaml格式的像这样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mail.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>children</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>webservers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>foo.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>bar.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dbservers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>one.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>two.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>three.example.com</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>如果ssh使用的不是标准端口，需要在inventory中标明：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>badwolf.example.com:5309
</span></span></code></pre></div><p>inventory支持使用变量定义主机：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>jumper ansible_port</span><span class=o>=</span><span class=s>5555 ansible_host=192.0.2.50</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jumper</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>5555</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.0.2.50</span><span class=w>
</span></span></span></code></pre></div><p>inventory支持模式匹配，如果主机类型模式类似，可以像这样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[webservers]</span>
</span></span><span class=line><span class=cl><span class=na>www[01:50].example.com</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[databases]</span>
</span></span><span class=line><span class=cl><span class=na>db-[a:f].example.com</span>
</span></span></code></pre></div><p>inventory支持定义连接类型和用户：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[targets]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>localhost              ansible_connection</span><span class=o>=</span><span class=s>local</span>
</span></span><span class=line><span class=cl><span class=na>other1.example.com     ansible_connection</span><span class=o>=</span><span class=s>ssh        ansible_user=mpdehaan</span>
</span></span><span class=line><span class=cl><span class=na>other2.example.com     ansible_connection</span><span class=o>=</span><span class=s>ssh        ansible_user=mdehaan</span>
</span></span></code></pre></div><p>可以在inventory中直接定义变量，但是更常用的方法是在host_vars目录的单独文件中进行定义，然后在inventory中进行引用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[atlanta]</span>
</span></span><span class=line><span class=cl><span class=na>host1 http_port</span><span class=o>=</span><span class=s>80 maxRequestsPerChild=808</span>
</span></span><span class=line><span class=cl><span class=na>host2 http_port</span><span class=o>=</span><span class=s>303 maxRequestsPerChild=909</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[atlanta]</span>
</span></span><span class=line><span class=cl><span class=na>host1</span>
</span></span><span class=line><span class=cl><span class=na>host2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[atlanta:vars]</span>
</span></span><span class=line><span class=cl><span class=na>ntp_server</span><span class=o>=</span><span class=s>ntp.atlanta.example.com</span>
</span></span><span class=line><span class=cl><span class=na>proxy</span><span class=o>=</span><span class=s>proxy.atlanta.example.com</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=p>[</span><span class=l>atlanta]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>host1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>host2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>atlanta:vars]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ntp_server=ntp.atlanta.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>proxy=proxy.atlanta.example.com</span><span class=w>
</span></span></span></code></pre></div><p>host和group均支持变量。但是切记，这只是一种表示方法，实际执行的时候会用literal替代。</p><p>inventory有两个默认组：all和ungrouped。all包含所有主机，ungrouped包含没有分组的主机。当然inventory支持更复杂的定义方式，但是，这只是入门级使用手册，不一一赘述。快点进入重点吧，怎么用Playbooks呢？</p><p>如果你有一间作坊，那么modules就是你的工具，Playbooks就是你的操作手册，inventory就是原料。</p><p>记住，Playbooks是ansible的语言、的语言、的语言&mldr;</p><h2 id=5ohnosophisticated-playbooks>5、Oh，No！sophisticated Playbooks&mldr;<a hidden class=anchor aria-hidden=true href=#5ohnosophisticated-playbooks>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>webservers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure apache is at the latest version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>write the apache config file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>/srv/httpd.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/etc/httpd.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>databases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure postgresql is at the latest version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgresql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure that postgresql is started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgresql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span></code></pre></div><p>这个Playbooks示例中，有两个play，第一个现在webservers group执行apache安装和配置，第二个在databases group执行postgresql安装和启动。Playbooks顺序执行。</p><blockquote><p><strong>Playbooks</strong> contain <strong>plays</strong></p><p><strong>Plays</strong> contain <strong>tasks</strong></p><p><strong>Tasks</strong> call <strong>modules</strong></p><p><strong>Tasks</strong> run sequentially</p><p><strong>Handlers</strong> are triggered by <strong>Tasks</strong>, and are run once, at the end of <strong>Plays</strong></p></blockquote><p>一个play必须指定目标主机和操作用户，注意是远程操作用户。目标主机通过<code>-hosts</code>指定，操作用户使用<code>remote_user</code>指定，支持细分task指定不同操作用户，支持用户切换。hosts是目标主机的列表，若有多组目标主机，使用冒号分割。一个play可以有多个task，每个task必须指定任务名称，任务调用模块，模块的调用格式为<code>module: options</code>。options分为key-value形式和非key-value形式的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>make sure apache is running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># key-value</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>enable selinux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>/sbin/setenforce 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># non key-value</span><span class=w>
</span></span></span></code></pre></div><p>根据上面的两个例子，可以看出options的格式根据modules发生变化。任务可以出发handler，比如两个任务task均涉及到nginx配置文件的修改，在task 的notify中均定义了handler，那么在play执行的最后，将只执行一次handler，避免nginx重复重启。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>template configuration file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>template.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/etc/foo.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>notify</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>restart memcached</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>restart apache</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>restart memcached</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memcached</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>restarted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>restart apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>restarted</span><span class=w>
</span></span></span></code></pre></div><p>执行Playbooks的命令行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible-playbook playbook.yml
</span></span></code></pre></div><p>一个简单的nginx安装示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>yum install nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://solaim.github.io/tags/python/>Python</a></li><li><a href=https://solaim.github.io/tags/ansible/>Ansible</a></li></ul><nav class=paginav><a class=prev href=https://solaim.github.io/posts/%E6%9C%80%E5%A5%BD%E7%9A%84%E5%91%8A%E5%88%AB/><span class=title>« Prev</span><br><span>最好的告别</span>
</a><a class=next href=https://solaim.github.io/posts/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/><span class=title>Next »</span><br><span>人工智能</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://solaim.github.io/>Jerry Wang</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>