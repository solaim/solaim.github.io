<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ansible | Jerry Wang</title>
<meta name=keywords content="Python,Ansible"><meta name=description content="1ã€ What is ansible?

Ansible is a radically simple IT automation engine that automatesÂ cloud provisioning,Â configuration management,Â application deployment,Â intra-service orchestration, and many other IT needs.
Ansibleæ˜¯ä¸€ä¸ªé¢ è¦†æ€§çš„è¿ç»´å·¥å…·ï¼Œæ”¯æŒäº‘é…ç½®ã€é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€æœåŠ¡ç¼–é…ç­‰è¿ç»´å·¥ä½œã€‚

Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.
Ansibleä¸€å¼€å§‹å°±æ˜¯ä¸ºå¤šå±‚æ¶æ„è®¾è®¡çš„ï¼Œå› æ­¤Ansibleé€šè¿‡æè¿°ç³»ç»Ÿå†…éƒ¨å…³ç³»ï¼Œè¿›è¡Œæ•´ä½“å»ºæ¨¡ã€‚


It uses no agents and no additional custom security infrastructure, so it&rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English."><meta name=author content="Jerry Wang"><link rel=canonical href=https://solaim.github.io/posts/ansible/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://solaim.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://solaim.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://solaim.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://solaim.github.io/apple-touch-icon.png><link rel=mask-icon href=https://solaim.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://solaim.github.io/posts/ansible/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://solaim.github.io/posts/ansible/"><meta property="og:site_name" content="Jerry Wang"><meta property="og:title" content="Ansible"><meta property="og:description" content="1ã€ What is ansible? Ansible is a radically simple IT automation engine that automatesÂ cloud provisioning,Â configuration management,Â application deployment,Â intra-service orchestration, and many other IT needs.
Ansibleæ˜¯ä¸€ä¸ªé¢ è¦†æ€§çš„è¿ç»´å·¥å…·ï¼Œæ”¯æŒäº‘é…ç½®ã€é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€æœåŠ¡ç¼–é…ç­‰è¿ç»´å·¥ä½œã€‚
Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.
Ansibleä¸€å¼€å§‹å°±æ˜¯ä¸ºå¤šå±‚æ¶æ„è®¾è®¡çš„ï¼Œå› æ­¤Ansibleé€šè¿‡æè¿°ç³»ç»Ÿå†…éƒ¨å…³ç³»ï¼Œè¿›è¡Œæ•´ä½“å»ºæ¨¡ã€‚
It uses no agents and no additional custom security infrastructure, so itâ€™s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-04-10T21:21:23+08:00"><meta property="article:modified_time" content="2019-04-10T21:21:23+08:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Ansible"><meta property="og:image" content="https://solaim.github.io/img/favicon.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://solaim.github.io/img/favicon.webp"><meta name=twitter:title content="Ansible"><meta name=twitter:description content="1ã€ What is ansible?

Ansible is a radically simple IT automation engine that automatesÂ cloud provisioning,Â configuration management,Â application deployment,Â intra-service orchestration, and many other IT needs.
Ansibleæ˜¯ä¸€ä¸ªé¢ è¦†æ€§çš„è¿ç»´å·¥å…·ï¼Œæ”¯æŒäº‘é…ç½®ã€é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€æœåŠ¡ç¼–é…ç­‰è¿ç»´å·¥ä½œã€‚

Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.
Ansibleä¸€å¼€å§‹å°±æ˜¯ä¸ºå¤šå±‚æ¶æ„è®¾è®¡çš„ï¼Œå› æ­¤Ansibleé€šè¿‡æè¿°ç³»ç»Ÿå†…éƒ¨å…³ç³»ï¼Œè¿›è¡Œæ•´ä½“å»ºæ¨¡ã€‚


It uses no agents and no additional custom security infrastructure, so it&rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://solaim.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Ansible","item":"https://solaim.github.io/posts/ansible/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ansible","name":"Ansible","description":"1ã€ What is ansible? Ansible is a radically simple IT automation engine that automatesÂ cloud provisioning,Â configuration management,Â application deployment,Â intra-service orchestration, and many other IT needs.\nAnsibleæ˜¯ä¸€ä¸ªé¢ è¦†æ€§çš„è¿ç»´å·¥å…·ï¼Œæ”¯æŒäº‘é…ç½®ã€é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€æœåŠ¡ç¼–é…ç­‰è¿ç»´å·¥ä½œã€‚\nDesigned for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.\nAnsibleä¸€å¼€å§‹å°±æ˜¯ä¸ºå¤šå±‚æ¶æ„è®¾è®¡çš„ï¼Œå› æ­¤Ansibleé€šè¿‡æè¿°ç³»ç»Ÿå†…éƒ¨å…³ç³»ï¼Œè¿›è¡Œæ•´ä½“å»ºæ¨¡ã€‚\nIt uses no agents and no additional custom security infrastructure, so it\u0026rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English.\n","keywords":["Python","Ansible"],"articleBody":"1ã€ What is ansible? Ansible is a radically simple IT automation engine that automatesÂ cloud provisioning,Â configuration management,Â application deployment,Â intra-service orchestration, and many other IT needs.\nAnsibleæ˜¯ä¸€ä¸ªé¢ è¦†æ€§çš„è¿ç»´å·¥å…·ï¼Œæ”¯æŒäº‘é…ç½®ã€é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€æœåŠ¡ç¼–é…ç­‰è¿ç»´å·¥ä½œã€‚\nDesigned for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.\nAnsibleä¸€å¼€å§‹å°±æ˜¯ä¸ºå¤šå±‚æ¶æ„è®¾è®¡çš„ï¼Œå› æ­¤Ansibleé€šè¿‡æè¿°ç³»ç»Ÿå†…éƒ¨å…³ç³»ï¼Œè¿›è¡Œæ•´ä½“å»ºæ¨¡ã€‚\nIt uses no agents and no additional custom security infrastructure, so itâ€™s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English.\nAnsible no agents no additional custom security infrastucture, it use ssh describe automation jobs by yaml 2ã€How to Ansible? å°½ç®¡å„ç§å¹³å°çš„ç®¡ç†å·¥å…·éƒ½å¯ä»¥å®‰è£…Ansibleï¼Œä½†æ˜¯Ansibleæ˜¯Pythonå¼€å‘çš„ï¼Œæ‰€ä»¥Ansibleçš„å®‰è£…å»ºè®®å°½é‡ä½¿ç”¨pip:\npip install ansible å¦‚æœæƒ³ä½¿ç”¨å¹³å°ç®¡ç†å·¥å…·å®‰è£…ï¼Œå…·ä½“æŸ¥è¯¢å®˜ç½‘ã€‚\næ£€æŸ¥å®‰è£…ç»“æœï¼š\nansible --version è¾“å‡ºç»“æœï¼š\nansible 2.7.6 config file = None configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Nov 6 2016, 00:28:07) [GCC 4.8.5 20150623 (Red Hat 4.8.5-11)] ä½¿ç”¨pipå®‰è£…çš„Ansibleæ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨ç”Ÿæˆã€‚ä½¿ç”¨å¹³å°å·¥å…·å®‰è£…ä¼šè‡ªåŠ¨ç”ŸæˆAnsibleé…ç½®æ–‡ä»¶ã€‚\nAnsibleçš„æ ¸å¿ƒæ˜¯Playbooksã€‚Playbooksæ˜¯ä¸€ä¸ªyamlæ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨äºæè¿°äº‹åŠ¡çŠ¶æ€ã€‚Playbooksçš„ä½¿ç”¨å˜é‡Variablesæè¿°ï¼ŒVariableså¯ä»¥åœ¨Playbooksã€Fileã€Inventoriesã€Command lineã€Discovered variablesã€Ansible Towerç­‰ä¸­å®šä¹‰ã€‚\nInventoriesç±»ä¼¼ä¸­è¯è¯æ–¹ï¼Œä¸­è¯è¯æ–¹åŸºæœ¬æ˜¯è¿™ä¹ˆå†™çš„ï¼š\nå½“å½’è²å­æ±¤ å½“å½’ ä¸¤é’± è²å­ å››é’± ... Inventoriesæè¿°æœåŠ¡å™¨çš„Hoståˆ—è¡¨ã€èŒƒå›´ã€åŠ¨æ€èŒƒå›´ä»¥åŠè‡ªå®šä¹‰ã€‚\nPlaybooks contain plays\nPlays contain tasks\nTasks call modules\nTasks run sequentially\nHandlers are triggered by Tasks, and are run once, at the end of Plays\né«˜çº§Playbooksæ”¯æŒæ¡ä»¶è§¦å‘ä»¥åŠroleç­‰ç‰¹å¾ã€‚å®šä¹‰å¥½Playbooksä¹‹åï¼Œå…·ä½“æ€ä¹ˆè¿è¡ŒAnsibleå‘¢ï¼Ÿ\nè¿è¡ŒAnsibleæœ‰ä¸‰ç§ä¸»æµçš„æ–¹å¼ï¼š\nAd-Hocï¼šansible -m Playbooksï¼šansible-playbook Automation Frameworkï¼šAnsible Tower(AWX) 3ã€Could you give me a demo? åˆ›å»ºansibleç›®å½• mkdir -p /etc/ansible åˆ›å»ºansible.cfg touch /etc/ansible/ansible.cfg ç¼–è¾‘ansible.cfg # config file for ansible -- https://ansible.com/ # =============================================== # nearly all parameters can be overridden in ansible-playbook # or with command line flags. ansible will read ANSIBLE_CONFIG, # ansible.cfg in the current working directory, .ansible.cfg in # the home directory or /etc/ansible/ansible.cfg, whichever it # finds first [defaults] # some basic default values... inventory = /etc/ansible/hosts library = /usr/share/ansible/ #module_utils = /usr/share/my_module_utils/ #remote_tmp = ~/.ansible/tmp #local_tmp = ~/.ansible/tmp #plugin_filters_cfg = /etc/ansible/plugin_filters.yml forks = 5 #poll_interval = 15 sudo_user = root #ask_sudo_pass = True #ask_pass = True #transport = smart remote_port = 22 #module_lang = C #module_set_locale = False [inventory] [privilege_escalation] [paramiko_connection] [ssh_connection] [persistent_connection] [accelerate] [selinux] [colors] [diff] è¯¦ç»†é…ç½®æ–‡ä»¶ï¼Œè¯·å‚è€ƒGithubç½‘é¡µã€‚\nç¼–è¾‘Inventory /etc/ansible/hosts 192.168.0.142 ä½¿ç”¨Ad-hocæ–¹å¼è¿è¡Œå‘½ä»¤ï¼š ansible all -m ping ansible all -a \"/bin/echo hello\" 4ã€Yelp, but how to do with complex deployment? Playbooks is really good!!!\nPlaybooks is really good!!!\nPlaybooks is really good!!!\nç—…æ¯”è¾ƒå¤æ‚ï¼Œå°±éœ€è¦ä¸€ç³»åˆ—å·¥å…·æ¥è¾…åŠ©æ²»ç–—ã€‚æœ€å¸¸ç”¨çš„å·¥å…·æœ‰ansibleå’Œansible-playbookã€‚ä½†æ˜¯è¿˜æœ‰å¾ˆå¤šå…¶ä»–å·¥å…·ï¼Œæ¯”å¦‚ï¼š\nansible-config: ç”¨äºæŸ¥çœ‹ã€ç¼–è¾‘ã€å’Œç®¡ç†ansibleé…ç½®ã€‚\nansible-consoleï¼šç”¨äºæ‰§è¡Œansible ad-hoc çš„repl consoleã€‚\nansible-docï¼šæ’ä»¶æ–‡æ¡£å·¥å…·ï¼Œç”¨äºæŸ¥çœ‹ansible modulesçš„æè¿°ä¿¡æ¯ã€‚\nansible-galaxyï¼šansibleæ‰§è¡Œè§’è‰²ç›¸å…³çš„æ“ä½œã€‚\nansible-inventoryï¼šç”¨äºæŸ¥çœ‹inventoryã€‚\nansible-pullï¼šä»VCSä»“åº“æ‹‰å–playbookså¹¶åœ¨æœ¬åœ°æ‰§è¡Œã€‚\nansible-vaultï¼šç”¨äºansibleæ•°æ®æ–‡ä»¶åŠ è§£å¯†ã€‚\nå·¥å…·ç”¨çš„ç†Ÿå°±å¥½ï¼Œä½†æ˜¯ä¸»è¦å·¥å…·ä¸ä»…è¦ç”¨çš„ç†Ÿï¼Œè¿˜å¾—ç”¨çš„å·§ã€‚ansibleå’Œansible-playbookå°±æ˜¯è¿™æ ·çš„å·¥å…·ã€‚\nansibleï¼šç”¨äºå®šä¹‰å’Œæ‰§è¡Œå•ä¸€ä»»åŠ¡\nansible-playbookï¼šè¿è¡Œansible playbookï¼Œåœ¨ç›®æ ‡ä¸»æœºç¾¤ä¸Šæ‰§è¡Œå®šä¹‰çš„ä»»åŠ¡ã€‚\næ¥çœ‹ä¸¤ä¸ªç®€å•çš„ansibleä½¿ç”¨ç¤ºä¾‹ï¼š\nansible all -a \"/sbin/reboot\" -f 10 ansible all -m shell -a 'echo $TERM' ç¬¬ä¸€ä¸ªä¾‹å­å¼€å¯10ä¸ªè¿›ç¨‹ï¼Œè®©æ‰€æœ‰ä¸»æœºé‡å¯ã€‚å½“ç„¶ï¼Œå¦‚æœallä¸­å®šä¹‰çš„ä¸»æœºæ•°ç›®å°äº10ï¼Œæ¯”å¦‚5ï¼Œé‚£ä¹ˆæœ‰5ä¸ªè¿›ç¨‹å°±æ˜¯ç©ºé—²çš„ã€‚å¦‚æœallä¸­æœ‰12ä¸ªä¸»æœºï¼Œé‚£ä¹ˆæœ‰ä¸¤ä¸ªä»»åŠ¡ä¼šç­‰å¾…ã€‚å‚æ•° -f 10 ç”¨æ¥æŒ‡å®šè¿›ç¨‹æ•°ç›®ã€‚\nç¬¬äºŒä¸ªä¾‹å­æ‰“å°TERMå‚æ•°ï¼Œä½†æ˜¯ä½¿ç”¨-mæŒ‡å®šäº†æ¨¡å—ï¼Œä¸€èˆ¬é»˜è®¤çš„æ¨¡å—æ˜¯â€™commandâ€™ã€‚\nè¿™ä¸¤ä¸ªéƒ½æ˜¯ç®€å•çš„ä¾‹å­ï¼Œansibleçš„æ¨¡å—æ”¯æŒæ›´åŠ å¤æ‚çš„ä»»åŠ¡ã€‚æ¯”å¦‚æ–‡ä»¶æ“ä½œï¼š\nansible all -m copy -a \"src=/etc/hosts dest=/tmp/hosts\" # ç±»ä¼¼äºscp ansible all -m file -a \"dest=/srv/foo/a.txt mode=600\" ansible all -m file -a \"dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan\" # ç±»ä¼¼äºchmodç­‰å‘½ä»¤ ansible webservers -m file -a \"dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory\" # ç±»ä¼¼äºmkdir -p ansible webservers -m file -a \"dest=/path/to/c state=absent\" # ç±»ä¼¼äºrm æ¯”å¦‚ç®¡ç†åŒ…ï¼š\nansible webservers -m yum -a \"name=acme state=present\" # ç¡®ä¿å®‰è£…ï¼Œä½†æ˜¯ä¸å‡çº§ ansible webservers -m yum -a \"name=acme-1.5 state=present\" # ç¡®ä¿å®‰è£…æŒ‡å®šç‰ˆæœ¬ ansible webservers -m yum -a \"name=acme state=latest\" # ç¡®ä¿å®‰è£…æœ€æ–°ç‰ˆæœ¬ ansible webservers -m yum -a \"name=acme state=absent\" # ç¡®ä¿æœªå®‰è£… æ¯”å¦‚ç”¨æˆ·å’Œç»„çš„ç®¡ç†ï¼š\nansible all -m user -a \"name=foo password=\" # åˆ›å»ºç”¨æˆ· ansible all -m user -a \"name=foo state=absent\" # åˆ é™¤ç”¨æˆ· æ¯”å¦‚æºç éƒ¨ç½²ï¼š\nansible webservers -m git -a \"repo=https://foo.example.org/repo.git dest=/srv/myapp version=HEAD\" æ¯”å¦‚æœåŠ¡ç®¡ç†ï¼š\nansible webservers -m service -a \"name=httpd state=started\" # å¼€å¯ ansible webservers -m service -a \"name=httpd state=restarted\" # é‡å¯ ansible webservers -m service -a \"name=httpd state=stopped\" # å…³é—­ æ¯”å¦‚é™æ—¶åå°ä»»åŠ¡ï¼š\nansible all -B 3600 -P 0 -a \"/usr/bin/long_running_operation --do-stuff\" # /usr/bin/long_running_operationä¸€ä¸ªåå°ä»»åŠ¡ï¼Œ-Bè¡¨ç¤ºè¶…æ—¶æ—¶é—´ï¼Œ-Pè¡¨ç¤ºè½®è¯¢polling ansible web1.example.com -m async_status -a \"jid=488359678239.2844\" # ä½¿ç”¨async_statusæ£€æŸ¥å¼‚æ­¥ä»»åŠ¡çŠ¶æ€ ansible all -B 1800 -P 60 -a \"/usr/bin/long_running_operation --do-stuff\" # åœ¨å¯åŠ¨ä»»åŠ¡çš„åŒæ—¶å¼€å¯è½®è¯¢æ¨¡å¼ï¼Œä»»åŠ¡æ‰§è¡Œ30åˆ†é’Ÿï¼Œæ¯60ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€ æ¯”å¦‚è·å–ç³»ç»Ÿä¿¡æ¯ï¼š\nansible all -m setup å—¯ï¼Œansible ad-hocæ˜¯å¾ˆå¥½ç”¨ï¼Œä½†æ˜¯æˆ‘æƒ³æŠŠä»»åŠ¡è®°å½•ä¸‹æ¥ï¼Œä¸‹æ¬¡ç›´æ¥æ‰§è¡Œï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ\nè¿™ä¸ªå°±è¦ç”¨åˆ°ansible-playbookäº†ï¼Œä¸è¿‡æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹inventoryã€‚\nansibleè¿è¡Œåœ¨å¤æ‚ç¯å¢ƒæ¶æ„ä¸­ï¼Œä¸ºäº†ä»»åŠ¡ç®¡ç†ã€è¿è¡Œæ–¹ä¾¿ï¼Œå¯ä»¥ä»inventory listä¸­é€‰å–éœ€è¦æ“ä½œçš„ä¸»æœºç»„è¿›è¡Œæ“ä½œã€‚inventoryé»˜è®¤çš„å­˜å‚¨æ–‡ä»¶æ˜¯/etc/ansible/hostsï¼Œä¸è¿‡å¯ä»¥ä½¿ç”¨-i pathè¿›è¡ŒæŒ‡å®šã€‚\ninventoryæ”¯æŒå¤šæ–‡ä»¶åŒæ—¶é…ç½®ï¼Œæ”¯æŒåŠ¨æ€æ‹‰å–ï¼Œæ”¯æŒä¸åŒæ ¼å¼çš„æ–‡ä»¶ã€‚\nmail.example.com [webservers] foo.example.com bar.example.com [dbservers] one.example.com two.example.com three.example.com è¿™æ˜¯ä¸€ä¸ªiniæ ¼å¼çš„inventoryï¼Œ[webservers]è¡¨ç¤ºgroupï¼Œå¯ä»¥æ–¹ä¾¿çš„é€‰å–æ‰§è¡Œç›¸å…³ä»»åŠ¡çš„ä¸»æœºï¼Œå¹¶ä¸”è¡¨æ˜ä¸»æœºçš„ç”¨é€”ã€‚yamlæ ¼å¼çš„åƒè¿™æ ·ï¼š\nall: hosts: mail.example.com: children: webservers: hosts: foo.example.com: bar.example.com: dbservers: hosts: one.example.com: two.example.com: three.example.com: å¦‚æœsshä½¿ç”¨çš„ä¸æ˜¯æ ‡å‡†ç«¯å£ï¼Œéœ€è¦åœ¨inventoryä¸­æ ‡æ˜ï¼š\nbadwolf.example.com:5309 inventoryæ”¯æŒä½¿ç”¨å˜é‡å®šä¹‰ä¸»æœºï¼š\njumper ansible_port=5555 ansible_host=192.0.2.50 ... hosts: jumper: ansible_port: 5555 ansible_host: 192.0.2.50 inventoryæ”¯æŒæ¨¡å¼åŒ¹é…ï¼Œå¦‚æœä¸»æœºç±»å‹æ¨¡å¼ç±»ä¼¼ï¼Œå¯ä»¥åƒè¿™æ ·ï¼š\n[webservers] www[01:50].example.com [databases] db-[a:f].example.com inventoryæ”¯æŒå®šä¹‰è¿æ¥ç±»å‹å’Œç”¨æˆ·ï¼š\n[targets] localhost ansible_connection=local other1.example.com ansible_connection=ssh ansible_user=mpdehaan other2.example.com ansible_connection=ssh ansible_user=mdehaan å¯ä»¥åœ¨inventoryä¸­ç›´æ¥å®šä¹‰å˜é‡ï¼Œä½†æ˜¯æ›´å¸¸ç”¨çš„æ–¹æ³•æ˜¯åœ¨host_varsç›®å½•çš„å•ç‹¬æ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰ï¼Œç„¶ååœ¨inventoryä¸­è¿›è¡Œå¼•ç”¨ï¼š\n[atlanta] host1 http_port=80 maxRequestsPerChild=808 host2 http_port=303 maxRequestsPerChild=909 [atlanta] host1 host2 [atlanta:vars] ntp_server=ntp.atlanta.example.com proxy=proxy.atlanta.example.com [atlanta] host1 host2 [atlanta:vars] ntp_server=ntp.atlanta.example.com proxy=proxy.atlanta.example.com hostå’Œgroupå‡æ”¯æŒå˜é‡ã€‚ä½†æ˜¯åˆ‡è®°ï¼Œè¿™åªæ˜¯ä¸€ç§è¡¨ç¤ºæ–¹æ³•ï¼Œå®é™…æ‰§è¡Œçš„æ—¶å€™ä¼šç”¨literalæ›¿ä»£ã€‚\ninventoryæœ‰ä¸¤ä¸ªé»˜è®¤ç»„ï¼šallå’Œungroupedã€‚allåŒ…å«æ‰€æœ‰ä¸»æœºï¼ŒungroupedåŒ…å«æ²¡æœ‰åˆ†ç»„çš„ä¸»æœºã€‚å½“ç„¶inventoryæ”¯æŒæ›´å¤æ‚çš„å®šä¹‰æ–¹å¼ï¼Œä½†æ˜¯ï¼Œè¿™åªæ˜¯å…¥é—¨çº§ä½¿ç”¨æ‰‹å†Œï¼Œä¸ä¸€ä¸€èµ˜è¿°ã€‚å¿«ç‚¹è¿›å…¥é‡ç‚¹å§ï¼Œæ€ä¹ˆç”¨Playbookså‘¢ï¼Ÿ\nå¦‚æœä½ æœ‰ä¸€é—´ä½œåŠï¼Œé‚£ä¹ˆmoduleså°±æ˜¯ä½ çš„å·¥å…·ï¼ŒPlaybookså°±æ˜¯ä½ çš„æ“ä½œæ‰‹å†Œï¼Œinventoryå°±æ˜¯åŸæ–™ã€‚\nè®°ä½ï¼ŒPlaybooksæ˜¯ansibleçš„è¯­è¨€ã€çš„è¯­è¨€ã€çš„è¯­è¨€â€¦\n5ã€Ohï¼ŒNoï¼sophisticated Playbooksâ€¦ - hosts: webservers remote_user: root tasks: - name: ensure apache is at the latest version yum: name: httpd state: latest - name: write the apache config file template: src: /srv/httpd.j2 dest: /etc/httpd.conf - hosts: databases remote_user: root tasks: - name: ensure postgresql is at the latest version yum: name: postgresql state: latest - name: ensure that postgresql is started service: name: postgresql state: started è¿™ä¸ªPlaybooksç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªplayï¼Œç¬¬ä¸€ä¸ªç°åœ¨webservers groupæ‰§è¡Œapacheå®‰è£…å’Œé…ç½®ï¼Œç¬¬äºŒä¸ªåœ¨databases groupæ‰§è¡Œpostgresqlå®‰è£…å’Œå¯åŠ¨ã€‚Playbooksé¡ºåºæ‰§è¡Œã€‚\nPlaybooks contain plays\nPlays contain tasks\nTasks call modules\nTasks run sequentially\nHandlers are triggered by Tasks, and are run once, at the end of Plays\nä¸€ä¸ªplayå¿…é¡»æŒ‡å®šç›®æ ‡ä¸»æœºå’Œæ“ä½œç”¨æˆ·ï¼Œæ³¨æ„æ˜¯è¿œç¨‹æ“ä½œç”¨æˆ·ã€‚ç›®æ ‡ä¸»æœºé€šè¿‡-hostsæŒ‡å®šï¼Œæ“ä½œç”¨æˆ·ä½¿ç”¨remote_useræŒ‡å®šï¼Œæ”¯æŒç»†åˆ†taskæŒ‡å®šä¸åŒæ“ä½œç”¨æˆ·ï¼Œæ”¯æŒç”¨æˆ·åˆ‡æ¢ã€‚hostsæ˜¯ç›®æ ‡ä¸»æœºçš„åˆ—è¡¨ï¼Œè‹¥æœ‰å¤šç»„ç›®æ ‡ä¸»æœºï¼Œä½¿ç”¨å†’å·åˆ†å‰²ã€‚ä¸€ä¸ªplayå¯ä»¥æœ‰å¤šä¸ªtaskï¼Œæ¯ä¸ªtaskå¿…é¡»æŒ‡å®šä»»åŠ¡åç§°ï¼Œä»»åŠ¡è°ƒç”¨æ¨¡å—ï¼Œæ¨¡å—çš„è°ƒç”¨æ ¼å¼ä¸ºmodule:Â optionsã€‚optionsåˆ†ä¸ºkey-valueå½¢å¼å’Œékey-valueå½¢å¼çš„ã€‚\ntasks: - name: make sure apache is running service: name: httpd state: started # key-value tasks: - name: enable selinux command: /sbin/setenforce 1 # non key-value æ ¹æ®ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ï¼Œå¯ä»¥çœ‹å‡ºoptionsçš„æ ¼å¼æ ¹æ®moduleså‘ç”Ÿå˜åŒ–ã€‚ä»»åŠ¡å¯ä»¥å‡ºå‘handlerï¼Œæ¯”å¦‚ä¸¤ä¸ªä»»åŠ¡taskå‡æ¶‰åŠåˆ°nginxé…ç½®æ–‡ä»¶çš„ä¿®æ”¹ï¼Œåœ¨task çš„notifyä¸­å‡å®šä¹‰äº†handlerï¼Œé‚£ä¹ˆåœ¨playæ‰§è¡Œçš„æœ€åï¼Œå°†åªæ‰§è¡Œä¸€æ¬¡handlerï¼Œé¿å…nginxé‡å¤é‡å¯ã€‚\nname: template configuration file template: src: template.j2 dest: /etc/foo.conf notify: - restart memcached - restart apache handlers: - name: restart memcached service: name: memcached state: restarted - name: restart apache service: name: apache state: restarted æ‰§è¡ŒPlaybooksçš„å‘½ä»¤è¡Œï¼š\nansible-playbook playbook.yml ä¸€ä¸ªç®€å•çš„nginxå®‰è£…ç¤ºä¾‹ï¼š\n- hosts: all remote_user: root tasks: - name: yum install nginx yum: name: nginx state: latest ","wordCount":"852","inLanguage":"en","image":"https://solaim.github.io/img/favicon.webp","datePublished":"2019-04-10T21:21:23+08:00","dateModified":"2019-04-10T21:21:23+08:00","author":{"@type":"Person","name":"Jerry Wang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://solaim.github.io/posts/ansible/"},"publisher":{"@type":"Organization","name":"Jerry Wang","logo":{"@type":"ImageObject","url":"https://solaim.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://solaim.github.io/ accesskey=h title="é¦–é¡µ (Alt + H)"><img src=https://solaim.github.io/apple-touch-icon.png alt aria-label=logo height=35>é¦–é¡µ</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://solaim.github.io/categories/ title=ğŸ•¸åˆ†ç±»><span>ğŸ•¸åˆ†ç±»</span></a></li><li><a href=https://solaim.github.io/tags/ title=ğŸšæ ‡ç­¾><span>ğŸšæ ‡ç­¾</span></a></li><li><a href=https://solaim.github.io/about/ title=ğŸŒå…³äº><span>ğŸŒå…³äº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://solaim.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://solaim.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Ansible</h1><div class=post-meta><span title='2019-04-10 21:21:23 +0800 +0800'>2019-04-10</span>&nbsp;Â·&nbsp;Jerry Wang</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#1-what-is-ansible>1ã€ What is ansible?</a></li><li><a href=#2how-to-ansible>2ã€How to Ansible?</a></li><li><a href=#3could-you-give-me-a-demo>3ã€Could you give me a demo?</a></li><li><a href=#4yelp-but-how-to-do-with-complex-deployment>4ã€Yelp, but how to do with complex deployment?</a></li><li><a href=#5ohnosophisticated-playbooks>5ã€Ohï¼ŒNoï¼sophisticated Playbooks&mldr;</a></li></ul></nav></div></details></div><div class=post-content><h2 id=1-what-is-ansible>1ã€ What is ansible?<a hidden class=anchor aria-hidden=true href=#1-what-is-ansible>#</a></h2><blockquote><p>Ansible is a radically simple IT automation engine that automatesÂ <em>cloud provisioning</em>,Â <em>configuration management</em>,Â <em>application deployment</em>,Â <em>intra-service orchestration</em>, and many other IT needs.</p></blockquote><p>Ansibleæ˜¯ä¸€ä¸ªé¢ è¦†æ€§çš„è¿ç»´å·¥å…·ï¼Œæ”¯æŒäº‘é…ç½®ã€é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€æœåŠ¡ç¼–é…ç­‰è¿ç»´å·¥ä½œã€‚</p><blockquote><p>Designed for multi-tier deployments since day one, Ansible models your IT infrastructure by describing how all of your systems inter-relate, rather than just managing one system at a time.</p></blockquote><p>Ansibleä¸€å¼€å§‹å°±æ˜¯ä¸ºå¤šå±‚æ¶æ„è®¾è®¡çš„ï¼Œå› æ­¤Ansibleé€šè¿‡æè¿°ç³»ç»Ÿå†…éƒ¨å…³ç³»ï¼Œè¿›è¡Œæ•´ä½“å»ºæ¨¡ã€‚</p><p><img alt=AnsibleArchitecture loading=lazy src=/img/AnsibleArchitecture.png></p><blockquote><p>It uses no agents and no additional custom security infrastructure, so it&rsquo;s easy to deploy - and most importantly, it uses a very simple language (YAML, in the form of Ansible Playbooks) that allow you to describe your automation jobs in a way that approaches plain English.</p></blockquote><ul><li>Ansible no agents</li><li>no additional custom security infrastucture, it use ssh</li><li>describe automation jobs by yaml</li></ul><h2 id=2how-to-ansible>2ã€How to Ansible?<a hidden class=anchor aria-hidden=true href=#2how-to-ansible>#</a></h2><p>å°½ç®¡å„ç§å¹³å°çš„ç®¡ç†å·¥å…·éƒ½å¯ä»¥å®‰è£…Ansibleï¼Œä½†æ˜¯Ansibleæ˜¯Pythonå¼€å‘çš„ï¼Œæ‰€ä»¥Ansibleçš„å®‰è£…å»ºè®®å°½é‡ä½¿ç”¨pip:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>pip install ansible
</span></span></code></pre></div><p>å¦‚æœæƒ³ä½¿ç”¨å¹³å°ç®¡ç†å·¥å…·å®‰è£…ï¼Œå…·ä½“æŸ¥è¯¢<a href=https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html>å®˜ç½‘</a>ã€‚</p><p>æ£€æŸ¥å®‰è£…ç»“æœï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible --version
</span></span></code></pre></div><p>è¾“å‡ºç»“æœï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible 2.7.6
</span></span><span class=line><span class=cl>  config <span class=nv>file</span> <span class=o>=</span> None
</span></span><span class=line><span class=cl>  configured module search <span class=nv>path</span> <span class=o>=</span> <span class=o>[</span>u<span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  ansible python module <span class=nv>location</span> <span class=o>=</span> /usr/lib/python2.7/site-packages/ansible
</span></span><span class=line><span class=cl>  executable <span class=nv>location</span> <span class=o>=</span> /usr/bin/ansible
</span></span><span class=line><span class=cl>  python <span class=nv>version</span> <span class=o>=</span> 2.7.5 <span class=o>(</span>default, Nov  <span class=m>6</span> 2016, 00:28:07<span class=o>)</span> <span class=o>[</span>GCC 4.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat 4.8.5-11<span class=o>)]</span>
</span></span></code></pre></div><p>ä½¿ç”¨pipå®‰è£…çš„Ansibleæ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨ç”Ÿæˆã€‚ä½¿ç”¨å¹³å°å·¥å…·å®‰è£…ä¼šè‡ªåŠ¨ç”ŸæˆAnsibleé…ç½®æ–‡ä»¶ã€‚</p><p>Ansibleçš„æ ¸å¿ƒæ˜¯<strong>Playbooks</strong>ã€‚<strong>Playbooks</strong>æ˜¯ä¸€ä¸ªyamlæ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨äºæè¿°äº‹åŠ¡çŠ¶æ€ã€‚<strong>Playbooks</strong>çš„ä½¿ç”¨å˜é‡<em>Variables</em>æè¿°ï¼Œ<em>Variables</em>å¯ä»¥åœ¨Playbooksã€Fileã€Inventoriesã€Command lineã€Discovered variablesã€Ansible Towerç­‰ä¸­å®šä¹‰ã€‚</p><p><strong>Inventories</strong>ç±»ä¼¼ä¸­è¯è¯æ–¹ï¼Œä¸­è¯è¯æ–¹åŸºæœ¬æ˜¯è¿™ä¹ˆå†™çš„ï¼š</p><pre tabindex=0><code>å½“å½’è²å­æ±¤

å½“å½’ ä¸¤é’±
è²å­ å››é’±
...
</code></pre><p><strong>Inventories</strong>æè¿°æœåŠ¡å™¨çš„Hoståˆ—è¡¨ã€èŒƒå›´ã€åŠ¨æ€èŒƒå›´ä»¥åŠè‡ªå®šä¹‰ã€‚</p><blockquote><p><strong>Playbooks</strong> contain <strong>plays</strong></p><p><strong>Plays</strong> contain <strong>tasks</strong></p><p><strong>Tasks</strong> call <strong>modules</strong></p><p><strong>Tasks</strong> run sequentially</p><p><strong>Handlers</strong> are triggered by <strong>Tasks</strong>, and are run once, at the end of <strong>Plays</strong></p></blockquote><p>é«˜çº§Playbooksæ”¯æŒæ¡ä»¶è§¦å‘ä»¥åŠroleç­‰ç‰¹å¾ã€‚å®šä¹‰å¥½Playbooksä¹‹åï¼Œå…·ä½“æ€ä¹ˆè¿è¡ŒAnsibleå‘¢ï¼Ÿ</p><p>è¿è¡ŒAnsibleæœ‰ä¸‰ç§ä¸»æµçš„æ–¹å¼ï¼š</p><ul><li>Ad-Hocï¼šansible -m</li><li>Playbooksï¼šansible-playbook</li><li>Automation Frameworkï¼šAnsible Tower(AWX)</li></ul><h2 id=3could-you-give-me-a-demo>3ã€Could you give me a demo?<a hidden class=anchor aria-hidden=true href=#3could-you-give-me-a-demo>#</a></h2><ul><li><input disabled type=checkbox> åˆ›å»ºansibleç›®å½•</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir -p /etc/ansible
</span></span></code></pre></div><ul><li><input disabled type=checkbox> åˆ›å»ºansible.cfg</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>touch /etc/ansible/ansible.cfg
</span></span></code></pre></div><ul><li><input disabled type=checkbox> ç¼–è¾‘ansible.cfg</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=c1># config file for ansible -- https://ansible.com/</span>
</span></span><span class=line><span class=cl><span class=c1># ===============================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nearly all parameters can be overridden in ansible-playbook</span>
</span></span><span class=line><span class=cl><span class=c1># or with command line flags. ansible will read ANSIBLE_CONFIG,</span>
</span></span><span class=line><span class=cl><span class=c1># ansible.cfg in the current working directory, .ansible.cfg in</span>
</span></span><span class=line><span class=cl><span class=c1># the home directory or /etc/ansible/ansible.cfg, whichever it</span>
</span></span><span class=line><span class=cl><span class=c1># finds first</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[defaults]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># some basic default values...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>inventory</span>      <span class=o>=</span> <span class=s>/etc/ansible/hosts</span>
</span></span><span class=line><span class=cl><span class=na>library</span>        <span class=o>=</span> <span class=s>/usr/share/ansible/</span>
</span></span><span class=line><span class=cl><span class=c1>#module_utils   = /usr/share/my_module_utils/</span>
</span></span><span class=line><span class=cl><span class=c1>#remote_tmp     = ~/.ansible/tmp</span>
</span></span><span class=line><span class=cl><span class=c1>#local_tmp      = ~/.ansible/tmp</span>
</span></span><span class=line><span class=cl><span class=c1>#plugin_filters_cfg = /etc/ansible/plugin_filters.yml</span>
</span></span><span class=line><span class=cl><span class=na>forks</span>          <span class=o>=</span> <span class=s>5</span>
</span></span><span class=line><span class=cl><span class=c1>#poll_interval  = 15</span>
</span></span><span class=line><span class=cl><span class=na>sudo_user</span>      <span class=o>=</span> <span class=s>root</span>
</span></span><span class=line><span class=cl><span class=c1>#ask_sudo_pass = True</span>
</span></span><span class=line><span class=cl><span class=c1>#ask_pass      = True</span>
</span></span><span class=line><span class=cl><span class=c1>#transport      = smart</span>
</span></span><span class=line><span class=cl><span class=na>remote_port</span>    <span class=o>=</span> <span class=s>22</span>
</span></span><span class=line><span class=cl><span class=c1>#module_lang    = C</span>
</span></span><span class=line><span class=cl><span class=c1>#module_set_locale = False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[inventory]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[privilege_escalation]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[paramiko_connection]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[ssh_connection]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[persistent_connection]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[accelerate]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[selinux]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[colors]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[diff]</span>
</span></span></code></pre></div><p>è¯¦ç»†é…ç½®æ–‡ä»¶ï¼Œè¯·å‚è€ƒGithub<a href=https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg>ç½‘é¡µ</a>ã€‚</p><ul><li><input disabled type=checkbox> ç¼–è¾‘Inventory /etc/ansible/hosts</li></ul><pre tabindex=0><code>192.168.0.142
</code></pre><ul><li><input disabled type=checkbox> ä½¿ç”¨Ad-hocæ–¹å¼è¿è¡Œå‘½ä»¤ï¼š</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m ping
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ansible all -a <span class=s2>&#34;/bin/echo hello&#34;</span>
</span></span></code></pre></div><h2 id=4yelp-but-how-to-do-with-complex-deployment>4ã€Yelp, but how to do with complex deployment?<a hidden class=anchor aria-hidden=true href=#4yelp-but-how-to-do-with-complex-deployment>#</a></h2><p><strong>Playbooks</strong> is really good!!!</p><p><strong>Playbooks</strong> is really good!!!</p><p><strong>Playbooks</strong> is really good!!!</p><p>ç—…æ¯”è¾ƒå¤æ‚ï¼Œå°±éœ€è¦ä¸€ç³»åˆ—å·¥å…·æ¥è¾…åŠ©æ²»ç–—ã€‚æœ€å¸¸ç”¨çš„å·¥å…·æœ‰ansibleå’Œansible-playbookã€‚ä½†æ˜¯è¿˜æœ‰å¾ˆå¤šå…¶ä»–å·¥å…·ï¼Œæ¯”å¦‚ï¼š</p><blockquote><p><strong>ansible-config</strong>: ç”¨äºæŸ¥çœ‹ã€ç¼–è¾‘ã€å’Œç®¡ç†ansibleé…ç½®ã€‚</p></blockquote><blockquote><p><strong>ansible-console</strong>ï¼šç”¨äºæ‰§è¡Œansible ad-hoc çš„repl consoleã€‚</p></blockquote><blockquote><p><strong>ansible-doc</strong>ï¼šæ’ä»¶æ–‡æ¡£å·¥å…·ï¼Œç”¨äºæŸ¥çœ‹ansible modulesçš„æè¿°ä¿¡æ¯ã€‚</p></blockquote><blockquote><p><strong>ansible-galaxy</strong>ï¼šansibleæ‰§è¡Œè§’è‰²ç›¸å…³çš„æ“ä½œã€‚</p></blockquote><blockquote><p><strong>ansible-inventory</strong>ï¼šç”¨äºæŸ¥çœ‹inventoryã€‚</p></blockquote><blockquote><p><strong>ansible-pull</strong>ï¼šä»VCSä»“åº“æ‹‰å–playbookså¹¶åœ¨æœ¬åœ°æ‰§è¡Œã€‚</p></blockquote><blockquote><p><strong>ansible-vault</strong>ï¼šç”¨äºansibleæ•°æ®æ–‡ä»¶åŠ è§£å¯†ã€‚</p></blockquote><p>å·¥å…·ç”¨çš„ç†Ÿå°±å¥½ï¼Œä½†æ˜¯ä¸»è¦å·¥å…·ä¸ä»…è¦ç”¨çš„ç†Ÿï¼Œè¿˜å¾—ç”¨çš„å·§ã€‚ansibleå’Œansible-playbookå°±æ˜¯è¿™æ ·çš„å·¥å…·ã€‚</p><blockquote><p><strong>ansible</strong>ï¼šç”¨äºå®šä¹‰å’Œæ‰§è¡Œå•ä¸€ä»»åŠ¡</p></blockquote><blockquote><p><strong>ansible-playbook</strong>ï¼šè¿è¡Œansible playbookï¼Œåœ¨ç›®æ ‡ä¸»æœºç¾¤ä¸Šæ‰§è¡Œå®šä¹‰çš„ä»»åŠ¡ã€‚</p></blockquote><p>æ¥çœ‹ä¸¤ä¸ªç®€å•çš„ansibleä½¿ç”¨ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -a <span class=s2>&#34;/sbin/reboot&#34;</span> -f <span class=m>10</span>
</span></span><span class=line><span class=cl>ansible all -m shell -a <span class=s1>&#39;echo $TERM&#39;</span>
</span></span></code></pre></div><p>ç¬¬ä¸€ä¸ªä¾‹å­å¼€å¯10ä¸ªè¿›ç¨‹ï¼Œè®©æ‰€æœ‰ä¸»æœºé‡å¯ã€‚å½“ç„¶ï¼Œå¦‚æœallä¸­å®šä¹‰çš„ä¸»æœºæ•°ç›®å°äº10ï¼Œæ¯”å¦‚5ï¼Œé‚£ä¹ˆæœ‰5ä¸ªè¿›ç¨‹å°±æ˜¯ç©ºé—²çš„ã€‚å¦‚æœallä¸­æœ‰12ä¸ªä¸»æœºï¼Œé‚£ä¹ˆæœ‰ä¸¤ä¸ªä»»åŠ¡ä¼šç­‰å¾…ã€‚å‚æ•° -f 10 ç”¨æ¥æŒ‡å®šè¿›ç¨‹æ•°ç›®ã€‚</p><p>ç¬¬äºŒä¸ªä¾‹å­æ‰“å°TERMå‚æ•°ï¼Œä½†æ˜¯ä½¿ç”¨-mæŒ‡å®šäº†æ¨¡å—ï¼Œä¸€èˆ¬é»˜è®¤çš„æ¨¡å—æ˜¯&rsquo;command&rsquo;ã€‚</p><p>è¿™ä¸¤ä¸ªéƒ½æ˜¯ç®€å•çš„ä¾‹å­ï¼Œansibleçš„æ¨¡å—æ”¯æŒæ›´åŠ å¤æ‚çš„ä»»åŠ¡ã€‚æ¯”å¦‚æ–‡ä»¶æ“ä½œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m copy -a <span class=s2>&#34;src=/etc/hosts dest=/tmp/hosts&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç±»ä¼¼äºscp</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m file -a <span class=s2>&#34;dest=/srv/foo/a.txt mode=600&#34;</span>
</span></span><span class=line><span class=cl>ansible all -m file -a <span class=s2>&#34;dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ç±»ä¼¼äºchmodç­‰å‘½ä»¤</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m file -a <span class=s2>&#34;dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç±»ä¼¼äºmkdir -p</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m file -a <span class=s2>&#34;dest=/path/to/c state=absent&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç±»ä¼¼äºrm</span>
</span></span></code></pre></div><p>æ¯”å¦‚ç®¡ç†åŒ…ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme state=present&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ç¡®ä¿å®‰è£…ï¼Œä½†æ˜¯ä¸å‡çº§</span>
</span></span><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme-1.5 state=present&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ç¡®ä¿å®‰è£…æŒ‡å®šç‰ˆæœ¬</span>
</span></span><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme state=latest&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ç¡®ä¿å®‰è£…æœ€æ–°ç‰ˆæœ¬</span>
</span></span><span class=line><span class=cl>ansible webservers -m yum -a <span class=s2>&#34;name=acme state=absent&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ç¡®ä¿æœªå®‰è£…</span>
</span></span></code></pre></div><p>æ¯”å¦‚ç”¨æˆ·å’Œç»„çš„ç®¡ç†ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m user -a <span class=s2>&#34;name=foo password=&lt;crypted password here&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºç”¨æˆ·</span>
</span></span><span class=line><span class=cl>ansible all -m user -a <span class=s2>&#34;name=foo state=absent&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># åˆ é™¤ç”¨æˆ·</span>
</span></span></code></pre></div><p>æ¯”å¦‚æºç éƒ¨ç½²ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m git -a <span class=s2>&#34;repo=https://foo.example.org/repo.git dest=/srv/myapp version=HEAD&#34;</span>
</span></span></code></pre></div><p>æ¯”å¦‚æœåŠ¡ç®¡ç†ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible webservers -m service -a <span class=s2>&#34;name=httpd state=started&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># å¼€å¯</span>
</span></span><span class=line><span class=cl>ansible webservers -m service -a <span class=s2>&#34;name=httpd state=restarted&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># é‡å¯</span>
</span></span><span class=line><span class=cl>ansible webservers -m service -a <span class=s2>&#34;name=httpd state=stopped&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># å…³é—­</span>
</span></span></code></pre></div><p>æ¯”å¦‚é™æ—¶åå°ä»»åŠ¡ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -B <span class=m>3600</span> -P <span class=m>0</span> -a <span class=s2>&#34;/usr/bin/long_running_operation --do-stuff&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># /usr/bin/long_running_operationä¸€ä¸ªåå°ä»»åŠ¡ï¼Œ-Bè¡¨ç¤ºè¶…æ—¶æ—¶é—´ï¼Œ-Pè¡¨ç¤ºè½®è¯¢polling</span>
</span></span><span class=line><span class=cl>ansible web1.example.com -m async_status -a <span class=s2>&#34;jid=488359678239.2844&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨async_statusæ£€æŸ¥å¼‚æ­¥ä»»åŠ¡çŠ¶æ€</span>
</span></span><span class=line><span class=cl>ansible all -B <span class=m>1800</span> -P <span class=m>60</span> -a <span class=s2>&#34;/usr/bin/long_running_operation --do-stuff&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># åœ¨å¯åŠ¨ä»»åŠ¡çš„åŒæ—¶å¼€å¯è½®è¯¢æ¨¡å¼ï¼Œä»»åŠ¡æ‰§è¡Œ30åˆ†é’Ÿï¼Œæ¯60ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€</span>
</span></span></code></pre></div><p>æ¯”å¦‚è·å–ç³»ç»Ÿä¿¡æ¯ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible all -m setup
</span></span></code></pre></div><p>å—¯ï¼Œansible ad-hocæ˜¯å¾ˆå¥½ç”¨ï¼Œä½†æ˜¯æˆ‘æƒ³æŠŠä»»åŠ¡è®°å½•ä¸‹æ¥ï¼Œä¸‹æ¬¡ç›´æ¥æ‰§è¡Œï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>è¿™ä¸ªå°±è¦ç”¨åˆ°ansible-playbookäº†ï¼Œä¸è¿‡æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹inventoryã€‚</p><p>ansibleè¿è¡Œåœ¨å¤æ‚ç¯å¢ƒæ¶æ„ä¸­ï¼Œä¸ºäº†ä»»åŠ¡ç®¡ç†ã€è¿è¡Œæ–¹ä¾¿ï¼Œå¯ä»¥ä»inventory listä¸­é€‰å–éœ€è¦æ“ä½œçš„ä¸»æœºç»„è¿›è¡Œæ“ä½œã€‚inventoryé»˜è®¤çš„å­˜å‚¨æ–‡ä»¶æ˜¯<code>/etc/ansible/hosts</code>ï¼Œä¸è¿‡å¯ä»¥ä½¿ç”¨<code>-i path</code>è¿›è¡ŒæŒ‡å®šã€‚</p><p>inventoryæ”¯æŒå¤šæ–‡ä»¶åŒæ—¶é…ç½®ï¼Œæ”¯æŒåŠ¨æ€æ‹‰å–ï¼Œæ”¯æŒä¸åŒæ ¼å¼çš„æ–‡ä»¶ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>mail.example.com</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[webservers]</span>
</span></span><span class=line><span class=cl><span class=na>foo.example.com</span>
</span></span><span class=line><span class=cl><span class=na>bar.example.com</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[dbservers]</span>
</span></span><span class=line><span class=cl><span class=na>one.example.com</span>
</span></span><span class=line><span class=cl><span class=na>two.example.com</span>
</span></span><span class=line><span class=cl><span class=na>three.example.com</span>
</span></span></code></pre></div><p>è¿™æ˜¯ä¸€ä¸ªiniæ ¼å¼çš„inventoryï¼Œ[webservers]è¡¨ç¤ºgroupï¼Œå¯ä»¥æ–¹ä¾¿çš„é€‰å–æ‰§è¡Œç›¸å…³ä»»åŠ¡çš„ä¸»æœºï¼Œå¹¶ä¸”è¡¨æ˜ä¸»æœºçš„ç”¨é€”ã€‚yamlæ ¼å¼çš„åƒè¿™æ ·ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mail.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>children</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>webservers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>foo.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>bar.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dbservers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>one.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>two.example.com</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>three.example.com</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><p>å¦‚æœsshä½¿ç”¨çš„ä¸æ˜¯æ ‡å‡†ç«¯å£ï¼Œéœ€è¦åœ¨inventoryä¸­æ ‡æ˜ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>badwolf.example.com:5309
</span></span></code></pre></div><p>inventoryæ”¯æŒä½¿ç”¨å˜é‡å®šä¹‰ä¸»æœºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=na>jumper ansible_port</span><span class=o>=</span><span class=s>5555 ansible_host=192.0.2.50</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jumper</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_port</span><span class=p>:</span><span class=w> </span><span class=m>5555</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.0.2.50</span><span class=w>
</span></span></span></code></pre></div><p>inventoryæ”¯æŒæ¨¡å¼åŒ¹é…ï¼Œå¦‚æœä¸»æœºç±»å‹æ¨¡å¼ç±»ä¼¼ï¼Œå¯ä»¥åƒè¿™æ ·ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[webservers]</span>
</span></span><span class=line><span class=cl><span class=na>www[01:50].example.com</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[databases]</span>
</span></span><span class=line><span class=cl><span class=na>db-[a:f].example.com</span>
</span></span></code></pre></div><p>inventoryæ”¯æŒå®šä¹‰è¿æ¥ç±»å‹å’Œç”¨æˆ·ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[targets]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>localhost              ansible_connection</span><span class=o>=</span><span class=s>local</span>
</span></span><span class=line><span class=cl><span class=na>other1.example.com     ansible_connection</span><span class=o>=</span><span class=s>ssh        ansible_user=mpdehaan</span>
</span></span><span class=line><span class=cl><span class=na>other2.example.com     ansible_connection</span><span class=o>=</span><span class=s>ssh        ansible_user=mdehaan</span>
</span></span></code></pre></div><p>å¯ä»¥åœ¨inventoryä¸­ç›´æ¥å®šä¹‰å˜é‡ï¼Œä½†æ˜¯æ›´å¸¸ç”¨çš„æ–¹æ³•æ˜¯åœ¨host_varsç›®å½•çš„å•ç‹¬æ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰ï¼Œç„¶ååœ¨inventoryä¸­è¿›è¡Œå¼•ç”¨ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[atlanta]</span>
</span></span><span class=line><span class=cl><span class=na>host1 http_port</span><span class=o>=</span><span class=s>80 maxRequestsPerChild=808</span>
</span></span><span class=line><span class=cl><span class=na>host2 http_port</span><span class=o>=</span><span class=s>303 maxRequestsPerChild=909</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[atlanta]</span>
</span></span><span class=line><span class=cl><span class=na>host1</span>
</span></span><span class=line><span class=cl><span class=na>host2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[atlanta:vars]</span>
</span></span><span class=line><span class=cl><span class=na>ntp_server</span><span class=o>=</span><span class=s>ntp.atlanta.example.com</span>
</span></span><span class=line><span class=cl><span class=na>proxy</span><span class=o>=</span><span class=s>proxy.atlanta.example.com</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=p>[</span><span class=l>atlanta]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>host1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>host2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>atlanta:vars]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ntp_server=ntp.atlanta.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>proxy=proxy.atlanta.example.com</span><span class=w>
</span></span></span></code></pre></div><p>hostå’Œgroupå‡æ”¯æŒå˜é‡ã€‚ä½†æ˜¯åˆ‡è®°ï¼Œè¿™åªæ˜¯ä¸€ç§è¡¨ç¤ºæ–¹æ³•ï¼Œå®é™…æ‰§è¡Œçš„æ—¶å€™ä¼šç”¨literalæ›¿ä»£ã€‚</p><p>inventoryæœ‰ä¸¤ä¸ªé»˜è®¤ç»„ï¼šallå’Œungroupedã€‚allåŒ…å«æ‰€æœ‰ä¸»æœºï¼ŒungroupedåŒ…å«æ²¡æœ‰åˆ†ç»„çš„ä¸»æœºã€‚å½“ç„¶inventoryæ”¯æŒæ›´å¤æ‚çš„å®šä¹‰æ–¹å¼ï¼Œä½†æ˜¯ï¼Œè¿™åªæ˜¯å…¥é—¨çº§ä½¿ç”¨æ‰‹å†Œï¼Œä¸ä¸€ä¸€èµ˜è¿°ã€‚å¿«ç‚¹è¿›å…¥é‡ç‚¹å§ï¼Œæ€ä¹ˆç”¨Playbookså‘¢ï¼Ÿ</p><p>å¦‚æœä½ æœ‰ä¸€é—´ä½œåŠï¼Œé‚£ä¹ˆmoduleså°±æ˜¯ä½ çš„å·¥å…·ï¼ŒPlaybookså°±æ˜¯ä½ çš„æ“ä½œæ‰‹å†Œï¼Œinventoryå°±æ˜¯åŸæ–™ã€‚</p><p>è®°ä½ï¼ŒPlaybooksæ˜¯ansibleçš„è¯­è¨€ã€çš„è¯­è¨€ã€çš„è¯­è¨€&mldr;</p><h2 id=5ohnosophisticated-playbooks>5ã€Ohï¼ŒNoï¼sophisticated Playbooks&mldr;<a hidden class=anchor aria-hidden=true href=#5ohnosophisticated-playbooks>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>webservers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure apache is at the latest version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>write the apache config file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>/srv/httpd.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/etc/httpd.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>databases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure postgresql is at the latest version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgresql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure that postgresql is started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>postgresql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span></code></pre></div><p>è¿™ä¸ªPlaybooksç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªplayï¼Œç¬¬ä¸€ä¸ªç°åœ¨webservers groupæ‰§è¡Œapacheå®‰è£…å’Œé…ç½®ï¼Œç¬¬äºŒä¸ªåœ¨databases groupæ‰§è¡Œpostgresqlå®‰è£…å’Œå¯åŠ¨ã€‚Playbooksé¡ºåºæ‰§è¡Œã€‚</p><blockquote><p><strong>Playbooks</strong> contain <strong>plays</strong></p><p><strong>Plays</strong> contain <strong>tasks</strong></p><p><strong>Tasks</strong> call <strong>modules</strong></p><p><strong>Tasks</strong> run sequentially</p><p><strong>Handlers</strong> are triggered by <strong>Tasks</strong>, and are run once, at the end of <strong>Plays</strong></p></blockquote><p>ä¸€ä¸ªplayå¿…é¡»æŒ‡å®šç›®æ ‡ä¸»æœºå’Œæ“ä½œç”¨æˆ·ï¼Œæ³¨æ„æ˜¯è¿œç¨‹æ“ä½œç”¨æˆ·ã€‚ç›®æ ‡ä¸»æœºé€šè¿‡<code>-hosts</code>æŒ‡å®šï¼Œæ“ä½œç”¨æˆ·ä½¿ç”¨<code>remote_user</code>æŒ‡å®šï¼Œæ”¯æŒç»†åˆ†taskæŒ‡å®šä¸åŒæ“ä½œç”¨æˆ·ï¼Œæ”¯æŒç”¨æˆ·åˆ‡æ¢ã€‚hostsæ˜¯ç›®æ ‡ä¸»æœºçš„åˆ—è¡¨ï¼Œè‹¥æœ‰å¤šç»„ç›®æ ‡ä¸»æœºï¼Œä½¿ç”¨å†’å·åˆ†å‰²ã€‚ä¸€ä¸ªplayå¯ä»¥æœ‰å¤šä¸ªtaskï¼Œæ¯ä¸ªtaskå¿…é¡»æŒ‡å®šä»»åŠ¡åç§°ï¼Œä»»åŠ¡è°ƒç”¨æ¨¡å—ï¼Œæ¨¡å—çš„è°ƒç”¨æ ¼å¼ä¸º<code>module:Â options</code>ã€‚optionsåˆ†ä¸ºkey-valueå½¢å¼å’Œékey-valueå½¢å¼çš„ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>make sure apache is running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>httpd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># key-value</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>enable selinux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>/sbin/setenforce 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># non key-value</span><span class=w>
</span></span></span></code></pre></div><p>æ ¹æ®ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ï¼Œå¯ä»¥çœ‹å‡ºoptionsçš„æ ¼å¼æ ¹æ®moduleså‘ç”Ÿå˜åŒ–ã€‚ä»»åŠ¡å¯ä»¥å‡ºå‘handlerï¼Œæ¯”å¦‚ä¸¤ä¸ªä»»åŠ¡taskå‡æ¶‰åŠåˆ°nginxé…ç½®æ–‡ä»¶çš„ä¿®æ”¹ï¼Œåœ¨task çš„notifyä¸­å‡å®šä¹‰äº†handlerï¼Œé‚£ä¹ˆåœ¨playæ‰§è¡Œçš„æœ€åï¼Œå°†åªæ‰§è¡Œä¸€æ¬¡handlerï¼Œé¿å…nginxé‡å¤é‡å¯ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>template configuration file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>template.j2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/etc/foo.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>notify</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>restart memcached</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>restart apache</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>restart memcached</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memcached</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>restarted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>restart apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>apache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>restarted</span><span class=w>
</span></span></span></code></pre></div><p>æ‰§è¡ŒPlaybooksçš„å‘½ä»¤è¡Œï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ansible-playbook playbook.yml
</span></span></code></pre></div><p>ä¸€ä¸ªç®€å•çš„nginxå®‰è£…ç¤ºä¾‹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>remote_user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>yum install nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://solaim.github.io/tags/python/>Python</a></li><li><a href=https://solaim.github.io/tags/ansible/>Ansible</a></li></ul><nav class=paginav><a class=prev href=https://solaim.github.io/posts/%E6%9C%80%E5%A5%BD%E7%9A%84%E5%91%8A%E5%88%AB/><span class=title>Â« Prev</span><br><span>æœ€å¥½çš„å‘Šåˆ«</span>
</a><a class=next href=https://solaim.github.io/posts/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/><span class=title>Next Â»</span><br><span>äººå·¥æ™ºèƒ½</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://solaim.github.io/>Jerry Wang</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>